<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex">  <meta name="built-on" content="2023-11-07T07:59:38.316955"><meta name="build-number" content="${buildNumber}">       <title>Hive 3 Upgrade Execution Process (u3e) | hive-sre</title><script id="virtual-toc-data" type="application/json">[{"id":"this-process-does-not-address","level":0,"title":"This process does NOT address","anchor":"#this-process-does-not-address"},{"id":"shortcut-the-partition-missing-directories-process","level":0,"title":"Shortcut the Partition Missing Directories Process","anchor":"#shortcut-the-partition-missing-directories-process"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.1.5-b176/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Hive 3 Upgrade Execution Process (u3e) | hive-sre"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="hive-sre Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="hive-sreu3e.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Hive 3 Upgrade Execution Process (u3e) | hive-sre"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "hive-sreu3e.html#webpage", "url": "hive-sreu3e.html", "name": "Hive 3 Upgrade Execution Process (u3e) | hive-sre", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "hive-sre/#website", "url": "hive-sre/", "name": "hive-sre Help" }</script><!-- End Schema.org --> <!-- Mermaid light/dark themes -->  <link rel="stylesheet" type="text/css" href="mermaid.css">  </head>     <body data-id="u3e" data-main-title="Hive 3 Upgrade Execution Process (u3e)" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="hive-sre.md|Introduction///hive-sre-Sub-Commands.md|Sub-Commands"  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>hive-sre  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="u3e"  id="u3e.md"  >Hive 3 Upgrade Execution Process (u3e)</h1>  <p id="cfd4d340_6387">The <code class="code" id="cfd4d340_6388">u3e</code> sub-command is used to 'execute' the upgrade scripts for Hive3 directly against the metastore database. Run against the metastore DB <span class="control" id="cfd4d340_6389">AFTER</span> the upgrade to Hive 3.</p><aside class="prompt" data-type="tip" data-title="" id="cfd4d340_6390"><p id="cfd4d340_6391">This process is meant to run <span class="control" id="cfd4d340_6392">AFTER</span> the upgrade and before the system is release for consumer access. It will work against the metastore DB directly, which is much faster than running the previous HiveSQL scripts for each table. You <span class="control" id="cfd4d340_6393">can</span> run this against the older Hive versions, but it may render some tables in a state that is NOT compatible with Hive 1/2.</p><p id="cfd4d340_6394">We suggest running this process against a 'copy' of the metastore db to understand the timings for upgrade planning.</p></aside><p id="cfd4d340_6395">Upgrade to CDP can run this process instead of the 'full' HSMM process run during the upgrade. See the <a href="https://docs.cloudera.com/cdp-private-cloud-upgrade/latest/upgrade-cdh/topics/hive-expedited-migration-tasks.html" id="cfd4d340_6396"   data-external="true" rel="noopener noreferrer" >Hive Expedited Upgrade</a>. If you run this <code class="code" id="cfd4d340_6397">u3e</code> process, most of the work will be done already. Create an empty includes file for HSMM and add it to the configuration as directed in the link above. This will ensure any 'database' changes are also applied.</p><p id="cfd4d340_6398">At this time, this process is ONLY available to MySQL/MariaDB backend metastore DB's.</p><p id="cfd4d340_6399">After running the <code class="code" id="cfd4d340_6400">u3</code> process to review the extent of the changes, you can run this script <span class="control" id="cfd4d340_6401">AFTER</span> the upgrade to Hive 3 to make the changes that cover:</p><ul class="list _ul" id="cfd4d340_6402"    ><li class="list__item" id="cfd4d340_6403"><p>Legacy Managed Non-Transactional (non-acid) Conversions to EXTERNAL/PURGE </p><ul class="list _ul" id="cfd4d340_6404"    ><li class="list__item" id="cfd4d340_6405"><p>Will convert all LEGACY MANAGED tables to EXTERNAL/PURGE</p></li></ul></li><li class="list__item" id="cfd4d340_6406"><p>ACID Table bucketing version update </p><ul class="list _ul" id="cfd4d340_6407"    ><li class="list__item" id="cfd4d340_6408"><p>Adds the correct bucket version property to ACID tables.</p></li></ul></li><li class="list__item" id="cfd4d340_6409"><p>Legacy Contrib Serde2 Replacement </p><ul class="list _ul" id="cfd4d340_6410"    ><li class="list__item" id="cfd4d340_6411"><p>Handles the conversions of: </p><ul class="list _ul" id="cfd4d340_6412"    ><li class="list__item" id="cfd4d340_6413"><p><code class="code" id="cfd4d340_6414">org.apache.hadoop.hive.contrib.serde2.RegexSerDe</code></p></li><li class="list__item" id="cfd4d340_6415"><p><code class="code" id="cfd4d340_6416">org.apache.hadoop.hive.contrib.serde2.TypedBytesSerDe</code></p></li><li class="list__item" id="cfd4d340_6417"><p><code class="code" id="cfd4d340_6418">org.apache.hadoop.hive.contrib.serde2.MultiDelimitSerDe</code></p></li></ul></li><li class="list__item" id="cfd4d340_6419"><p>Other Serdes identified in the <code class="code" id="cfd4d340_6420">u3</code> process will need to be independently addressed.</p></li></ul></li></ul><p id="cfd4d340_6421">These scripts will execute directly against the METASTORE DB, skipping the HiveSQL interface. This process is considerably faster than processing these requests through the HiveSQL interface 1 at a time.</p><section class="chapter"><h2 id="this-process-does-not-address" data-toc="this-process-does-not-address">This process does NOT address</h2><ul class="list _ul" id="cfd4d340_6422"    ><li class="list__item" id="cfd4d340_6423"><p>Kudu Serde / Table Upgrades. See: https://kudu.apache.org/docs/hive_metastore.html</p></li><li class="list__item" id="cfd4d340_6424"><p>Legacy Decimal (Hive 0.12) issues. Refer to description of these in the <code class="code" id="cfd4d340_6425">u3</code> report.</p></li></ul></section><section class="chapter"><h2 id="shortcut-the-partition-missing-directories-process" data-toc="shortcut-the-partition-missing-directories-process">Shortcut the Partition Missing Directories Process</h2><p id="cfd4d340_6426">The output of the <code class="code" id="cfd4d340_6427">u3 -hdp2|-cdh</code> process creates an output file called <code class="code" id="cfd4d340_6428">loc_scan_missing_dirs.md</code> that contains a list of all the existing partitions that have no matching directory on the filesystem. In the report, there are several options available to correct these inconsistencies. You can create empty directories that match the partition definitions, or remove the partitions via HiveSQL.</p><p id="cfd4d340_6429">Of these two options, dropping the partitions in Hive is preferred. But a large number of these inconsistencies can take a lot of time to run via HiveSQL. An alternative is available that builds a list of the partition ids and then build out the <code class="code" id="cfd4d340_6430">MYSQL</code> scripts to drop them from the metastore directly. This process is much faster than running the HiveSQL scripts.</p><p id="cfd4d340_6431">Run the <code class="code" id="cfd4d340_6432">u3</code> process as normal to generate the <code class="code" id="cfd4d340_6433">loc_scan_missing_dirs.md</code> file. Installed in the path is a script called <code class="code" id="cfd4d340_6434">mysql_missing_parts.sh</code>, which should be on the path (in same directory as the <code class="code" id="cfd4d340_6435">hive-sre</code> script.</p><p id="cfd4d340_6436"><span class="control" id="cfd4d340_6437">Recommend starting small with a test hive database first.</span></p><p id="cfd4d340_6438"><span class="control" id="cfd4d340_6439">BACKUP THE METASTORE DB BEFORE RUNNING THIS PROCESS</span></p><ol class="list _decimal" id="cfd4d340_6440"  type="1"  ><li class="list__item" id="cfd4d340_6441"><p><code class="code" id="cfd4d340_6442">cd &lt;report_output_directory&gt;</code> (where the <code class="code" id="cfd4d340_6443">loc_scan_missing_dirs.md</code> file is).</p></li><li class="list__item" id="cfd4d340_6444"><p>run: <code class="code" id="cfd4d340_6445">mysql_missing_parts.sh loc_scan_missing_dirs.md</code>. In the output directory this generates an <code class="code" id="cfd4d340_6446">mysql</code> script file called <code class="code" id="cfd4d340_6447">mysql_missing_parts.sql</code>.</p></li><li class="list__item" id="cfd4d340_6448"><p>run the <code class="code" id="cfd4d340_6449">mysql_missing_parts.sql</code> script through your favorite <span class="control" id="cfd4d340_6450">MYSQL</span> cli application against that metastore RDBMS.</p></li><li class="list__item" id="cfd4d340_6451"><p>rerun the <code class="code" id="cfd4d340_6452">u3</code> process to confirm the partition discrepancies are gone.</p></li></ol></section><div class="last-modified"> Last modified: 07 November 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="to-cdp.html">Upgrading to CDP</a>   <a class="navigation-links__next" href="hive-sre-u3e-procs.html">Procedures</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.1.5-b176/app.js"></script></body></html>