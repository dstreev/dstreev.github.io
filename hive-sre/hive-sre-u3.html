<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex">  <meta name="built-on" content="2023-11-06T11:07:20.624471"><meta name="build-number" content="${buildNumber}">       <title>Hive Upgrade Check (u3) | hive-sre</title><script id="virtual-toc-data" type="application/json">[{"id":"quick-start-what-to-do","level":0,"title":"Quick Start (What to do!!!)","anchor":"#quick-start-what-to-do"},{"id":"testing","level":0,"title":"Testing","anchor":"#testing"},{"id":"known-issues","level":0,"title":"Known Issues","anchor":"#known-issues"},{"id":"assumptions","level":0,"title":"Assumptions","anchor":"#assumptions"},{"id":"application-help","level":0,"title":"Application Help","anchor":"#application-help"},{"id":"u3-processes","level":0,"title":"u3 Processes","anchor":"#u3-processes"},{"id":"running","level":0,"title":"Running","anchor":"#running"},{"id":"output","level":0,"title":"Output","anchor":"#output"},{"id":"check-and-validations-performed","level":0,"title":"Check and Validations Performed","anchor":"#check-and-validations-performed"},{"id":"getting-ready-for-a-hive-1-2-to-hive-3-upgrade","level":0,"title":"Getting Ready for a Hive 1/2 to Hive 3 Upgrade","anchor":"#getting-ready-for-a-hive-1-2-to-hive-3-upgrade"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.1.5-b176/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Hive Upgrade Check (u3) | hive-sre"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="hive-sre Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="hive-srehive-sre-u3.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Hive Upgrade Check (u3) | hive-sre"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "hive-srehive-sre-u3.html#webpage", "url": "hive-srehive-sre-u3.html", "name": "Hive Upgrade Check (u3) | hive-sre", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "hive-sre/#website", "url": "hive-sre/", "name": "hive-sre Help" }</script><!-- End Schema.org --> <!-- Mermaid light/dark themes -->  <link rel="stylesheet" type="text/css" href="mermaid.css">  </head>     <body data-id="hive-sre-u3" data-main-title="Hive Upgrade Check (u3)" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="hive-sre.md|Introduction///hive-sre-Sub-Commands.md|Sub-Commands"  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>hive-sre  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="hive-sre-u3"  id="hive-sre-u3.md"  >Hive Upgrade Check (u3)</h1>  <p id="986630c8_18397">The <code class="code" id="986630c8_18398">u3</code> sub-command is a process that is used to review 'Hive 1/2' environments for Hive3 upgrade planning.</p><p id="986630c8_18399">Review Hive Metastore Databases and Tables for upgrade or simply to evaluate potential issues. The intent was to make that process much more prescriptive and consumable by Cloudera customers. The application is 'Apache Hive' based, so it should work against both 'HDP', 'CDH', and 'CDP' clusters. See additional details about <a href="to-cdp.html" id="986630c8_18400" data-tooltip="CDP 7.x+ is running Hive 3. Platforms running Hive 1/2 (CDH 5/6 and HDP 2) need to upgrade/convert tables so they are compatible with Hive 3."  >upgrading HDP2 and CDP 5/6 to CDP</a>.</p><section class="chapter"><h2 id="quick-start-what-to-do" data-toc="quick-start-what-to-do">Quick Start (What to do!!!)</h2><p id="986630c8_18401">This process can be a long running process. I recommend using <code class="code" id="986630c8_18402">screen</code> or <code class="code" id="986630c8_18403">tmux</code> sessions to run it. That way the session won't get terminated when you disconnect from the host and you can easily reattach later to see the progress.</p><p id="986630c8_18404">The process should start registering counts pretty quickly for each of the sub-checks. If you do not see these counts moving, or they show <code class="code" id="986630c8_18405">0</code>, check your connection to the Metastore database (IE: URL, RDBMS Driver(needs to be in $HOME/.hive-sre/aux_libs), Username, password, and/or permissions). <code class="code" id="986630c8_18406">hive-sre</code> versions 2.4.0.21.0 and above will catch some of these misconfigurations and exit quickly.</p><p id="986630c8_18407">Logs for the application are at $HOME/.hive-sre/logs. Check those for details on progress and/or problems.</p><section class="chapter"><h3 id="use-the-platform-flag-to-run-only-the-important-reports" data-toc="use-the-platform-flag-to-run-only-the-important-reports">Use the Platform flag to run ONLY the important reports.</h3><p id="986630c8_18408">Use one of <code class="code" id="986630c8_18409">-cdh</code>, <code class="code" id="986630c8_18410">-hdp2</code>, or <code class="code" id="986630c8_18411">-hdp3</code> depending on your source platform to run only the reports that make sense. If you don't use one of these options, that's fine. Just know that you'll be running MORE reports than you need and the process will run much longer. Just saying....</p><p id="986630c8_18412">EACH report contains a description <span class="control" id="986630c8_18413">within</span> the report on what actions should be taken.</p><p id="986630c8_18414">If you are running the default upgrade and NOT doing the CDP Expedited Hive Upgrade Process for <a href="https://docs.cloudera.com/cdp-private-cloud-upgrade/latest/upgrade-cdh/topics/hive-expedite-cdh-overview.html" id="986630c8_18415"   data-external="true" rel="noopener noreferrer" >CDH5</a>, <a href="https://docs.cloudera.com/cdp-private-cloud-upgrade/latest/upgrade-cdh6/topics/hive-expedite-cdh-overview.html" id="986630c8_18416"   data-external="true" rel="noopener noreferrer" >CDH6</a>, <a href="https://docs.cloudera.com/cdp-private-cloud-upgrade/latest/upgrade-hdp/topics/hive-expedite-hdp-overview.html" id="986630c8_18417"   data-external="true" rel="noopener noreferrer" >HDP2</a> there is a HSMM (Hive Strict Managed Migration Process) that runs AFTER the binaries and components have been upgraded to CDP's Hive 3. This process (HSMM) will fail if the issues/errors reported in reports <a href="hive-sre-u3-loc-scan-missing-dirs.html" id="986630c8_18418" data-tooltip="truncated for brevity..."  >1 - Table / Partition Location Scan - Missing Directories</a>, <a href="hive-sre-u3-hms-checks.html" id="986630c8_18419" data-tooltip="Listed tables should be review to ensure the Serde is still available. Missing Serde's can disrupt a Hive Upgrade/Migration Process"  >5 - Questionable Serde's Check</a> are not fixed BEFORE doing the upgrade.</p><p id="986630c8_18420">Metadata Updates, like <a href="hive-sre-u3-managed-upgrade-2-acid.html" id="986630c8_18421" data-tooltip="Managed Upgrade 2 ACID Hive 3 Upgrade Checks - Managed Non-ACID to ACID Table Migrations -- Table is owned by 'dstreev', not 'hive', and NOT currently ACID. -- This table 'could' be migrated to an ACID table unless changed. -- Recommend forcing the manual conversion to ensure table&hellip;"  >3 - Hive 3 Upgrade Checks - Managed Non-ACID to ACID Table Migrations</a> are done after the components and configurations have been updated to CDP. Therefore, the report actions for <a href="hive-sre-u3-managed-upgrade-2-acid.html" id="986630c8_18422" data-tooltip="Managed Upgrade 2 ACID Hive 3 Upgrade Checks - Managed Non-ACID to ACID Table Migrations -- Table is owned by 'dstreev', not 'hive', and NOT currently ACID. -- This table 'could' be migrated to an ACID table unless changed. -- Recommend forcing the manual conversion to ensure table&hellip;"  >3 - Hive 3 Upgrade Checks - Managed Non-ACID to ACID Table Migrations</a> and <a href="hive-sre-u3-acid-bucketing-update.html" id="986630c8_18423" data-tooltip="ACID Bucket Version Update -- Basic Processing (Skip Command Check specified) ALTER TABLE default.legacy_acid_01 SET TBLPROPERTIES('bucketing_version'='2'); ALTER TABLE tpcds_bin_partitioned_orc_10.call_center_acid SET TBLPROPERTIES('bucketing_version'='2'); ALTER TABLE&hellip;"  >6 - Provide Script for ACID tables missing the 'bucketing_version' property</a> will be done by HSMM.</p><p id="986630c8_18424">If you are doing the Expedited Hive Upgrade process there are two options:</p><ol class="list _decimal" id="986630c8_18425"  type="1"  ><li class="list__item" id="986630c8_18426"><p>Skip the HSMM process altogether. This means you will need to run the actions from the following, manually. These actions can be done BEFORE the upgrade, BUT may change behaviors expected in the legacy platform. They can be done AFTER the upgrade where there isn't a behavior impact. These will take time and dependent on the number of actions you need to perform. The tables must be updated BEFORE they can be consumed by users. But this doesn't mean you need to hold the upgrade or increase the downtime of the cluster. Organized high priority DBs first and work on less accessed DBs later. </p><ol class="list _decimal" id="986630c8_18427"  type="1"  ><li class="list__item" id="986630c8_18428"><p><a href="hive-sre-u3-managed-upgrade-2-acid.html" id="986630c8_18429" data-tooltip="Managed Upgrade 2 ACID Hive 3 Upgrade Checks - Managed Non-ACID to ACID Table Migrations -- Table is owned by 'dstreev', not 'hive', and NOT currently ACID. -- This table 'could' be migrated to an ACID table unless changed. -- Recommend forcing the manual conversion to ensure table&hellip;"  >3 - Hive 3 Upgrade Checks - Managed Non-ACID to ACID Table Migrations</a></p></li><li class="list__item" id="986630c8_18430"><p><a href="hive-sre-u3-acid-bucketing-update.html" id="986630c8_18431" data-tooltip="ACID Bucket Version Update -- Basic Processing (Skip Command Check specified) ALTER TABLE default.legacy_acid_01 SET TBLPROPERTIES('bucketing_version'='2'); ALTER TABLE tpcds_bin_partitioned_orc_10.call_center_acid SET TBLPROPERTIES('bucketing_version'='2'); ALTER TABLE&hellip;"  >6 - Provide Script for ACID tables missing the 'bucketing_version' property</a></p></li></ol></li><li class="list__item" id="986630c8_18432"><p>Use the hsmm_includelist.yaml produced by <code class="code" id="986630c8_18433">u3</code> to direct HSMM towards targeted actions. See the Expedite Hive Upgrade docs for details.</p></li></ol><section class="chapter"><h4 id="hdp2" data-toc="hdp2">HDP2</h4><p id="986630c8_18434">Runs reports:</p><ul class="list _ul" id="986630c8_18435"    ><li class="list__item" id="986630c8_18436"><p><a href="hive-sre-u3-loc-scan-missing-dirs.html" id="986630c8_18437" data-tooltip="truncated for brevity..."  >1</a> - Table / Partition Location Scan - Missing Directories</p></li><li class="list__item" id="986630c8_18438"><p><a href="hive-sre-u3-managed-upgrade-2-acid.html" id="986630c8_18439" data-tooltip="Managed Upgrade 2 ACID Hive 3 Upgrade Checks - Managed Non-ACID to ACID Table Migrations -- Table is owned by 'dstreev', not 'hive', and NOT currently ACID. -- This table 'could' be migrated to an ACID table unless changed. -- Recommend forcing the manual conversion to ensure table&hellip;"  >3</a> - Hive 3 Upgrade Checks - Managed Non-ACID to ACID Table Migrations</p></li><li class="list__item" id="986630c8_18440"><p><a href="hive-sre-u3-managed-compactions.html" id="986630c8_18441" data-tooltip="Managed Compactions -- Hive 3 - Compaction Check ALTER TABLE covid_ga.county_cases_archive PARTITION (year_month=&quot;RUN_1&quot;) COMPACT &quot;MAJOR&quot;; ALTER TABLE covid_ga.county_cases_archive PARTITION (year_month=&quot;2020-08&quot;) COMPACT &quot;MAJOR&quot;; ALTER TABLE&hellip;"  >4</a> - Hive 3 Upgrade Checks - Compaction Check</p></li><li class="list__item" id="986630c8_18442"><p><a href="hive-sre-u3-hms-checks.html" id="986630c8_18443" data-tooltip="Listed tables should be review to ensure the Serde is still available. Missing Serde's can disrupt a Hive Upgrade/Migration Process"  >5</a> - Hive Metastore Check </p><br><p> - Questionable Serde's Check</p><br><p> - Questionable Serde's Check</p><br><p> - Leagcy Kudu Serde Report</p><br><p> - Legacy Decimal Scale/Precision Check</p><br><p> - List Databases with Table/Partition Counts</p></li><li class="list__item" id="986630c8_18449"><p><a href="hive-sre-u3-acid-bucketing-update.html" id="986630c8_18450" data-tooltip="ACID Bucket Version Update -- Basic Processing (Skip Command Check specified) ALTER TABLE default.legacy_acid_01 SET TBLPROPERTIES('bucketing_version'='2'); ALTER TABLE tpcds_bin_partitioned_orc_10.call_center_acid SET TBLPROPERTIES('bucketing_version'='2'); ALTER TABLE&hellip;"  >6</a> - Provide Script for ACID tables missing the 'bucketing_version' property</p></li><li class="list__item" id="986630c8_18451"><p>7 - List tables using known Storage Handlers</p></li><li class="list__item" id="986630c8_18452"><p>8 - Hive 3 Upgrade Checks - List Managed Non-ACID tables that need to be converted. (Run <code class="code" id="986630c8_18453">u3e</code> to process)</p></li><li class="list__item" id="986630c8_18454"><p>9 - List ACID tables missing the 'bucketing_version' property (Run <code class="code" id="986630c8_18455">u3e</code> to process)</p></li></ul></section><section class="chapter"><h4 id="hdp3" data-toc="hdp3">HDP3</h4><p id="986630c8_18456">Runs reports:</p><ul class="list _ul" id="986630c8_18457"    ><li class="list__item" id="986630c8_18458"><p><a href="hive-sre-u3-loc-scan-missing-dirs.html" id="986630c8_18459" data-tooltip="truncated for brevity..."  >1</a> - Table / Partition Location Scan - Missing Directories</p></li><li class="list__item" id="986630c8_18460"><p><a href="hive-sre-u3-hms-checks.html" id="986630c8_18461" data-tooltip="Listed tables should be review to ensure the Serde is still available. Missing Serde's can disrupt a Hive Upgrade/Migration Process"  >5</a> - Hive Metastore Check </p><br><p> - Questionable Serde's Check</p><br><p> - Questionable Serde's Check</p><br><p> - Leagcy Kudu Serde Report</p><br><p> - Legacy Decimal Scale/Precision Check</p><br><p> - List Databases with Table/Partition Counts</p></li><li class="list__item" id="986630c8_18467"><p><a href="hive-sre-u3-acid-bucketing-update.html" id="986630c8_18468" data-tooltip="ACID Bucket Version Update -- Basic Processing (Skip Command Check specified) ALTER TABLE default.legacy_acid_01 SET TBLPROPERTIES('bucketing_version'='2'); ALTER TABLE tpcds_bin_partitioned_orc_10.call_center_acid SET TBLPROPERTIES('bucketing_version'='2'); ALTER TABLE&hellip;"  >6</a> - Provide Script for ACID tables missing the 'bucketing_version' property</p></li></ul></section><section class="chapter"><h4 id="cdh" data-toc="cdh">CDH</h4><p id="986630c8_18469">Runs reports:</p><ul class="list _ul" id="986630c8_18470"    ><li class="list__item" id="986630c8_18471"><p><a href="hive-sre-u3-loc-scan-missing-dirs.html" id="986630c8_18472" data-tooltip="truncated for brevity..."  >1</a> - Table / Partition Location Scan - Missing Directories</p></li><li class="list__item" id="986630c8_18473"><p><a href="hive-sre-u3-managed-upgrade-2-acid.html" id="986630c8_18474" data-tooltip="Managed Upgrade 2 ACID Hive 3 Upgrade Checks - Managed Non-ACID to ACID Table Migrations -- Table is owned by 'dstreev', not 'hive', and NOT currently ACID. -- This table 'could' be migrated to an ACID table unless changed. -- Recommend forcing the manual conversion to ensure table&hellip;"  >3</a> - Hive 3 Upgrade Checks - Managed Non-ACID to ACID Table Migrations</p></li><li class="list__item" id="986630c8_18475"><p><a href="hive-sre-u3-hms-checks.html" id="986630c8_18476" data-tooltip="Listed tables should be review to ensure the Serde is still available. Missing Serde's can disrupt a Hive Upgrade/Migration Process"  >5</a> - Hive Metastore Check </p><br><p> - Questionable Serde's Check</p><br><p> - Questionable Serde's Check</p><br><p> - Leagcy Kudu Serde Report</p><br><p> - Legacy Decimal Scale/Precision Check</p><br><p> - List Databases with Table/Partition Counts</p></li><li class="list__item" id="986630c8_18482"><p><a href="hive-sre-u3-acid-bucketing-update.html" id="986630c8_18483" data-tooltip="ACID Bucket Version Update -- Basic Processing (Skip Command Check specified) ALTER TABLE default.legacy_acid_01 SET TBLPROPERTIES('bucketing_version'='2'); ALTER TABLE tpcds_bin_partitioned_orc_10.call_center_acid SET TBLPROPERTIES('bucketing_version'='2'); ALTER TABLE&hellip;"  >6</a> - Provide Script for ACID tables missing the 'bucketing_version' property</p></li><li class="list__item" id="986630c8_18484"><p>7 - List tables using known Storage Handlers</p></li><li class="list__item" id="986630c8_18485"><p>8 - Hive 3 Upgrade Checks - List Managed Non-ACID tables that need to be converted. (Run <code class="code" id="986630c8_18486">u3e</code> to process)</p></li><li class="list__item" id="986630c8_18487"><p>9 - List ACID tables missing the 'bucketing_version' property (Run <code class="code" id="986630c8_18488">u3e</code> to process)</p></li></ul></section></section></section><section class="chapter"><h2 id="testing" data-toc="testing">Testing</h2><p id="986630c8_18489">I have tested this against MariaDB 10.2, Postgres, and Oracle. I have seen reports of SQL issues against MySql 5.6, so this process will certainly have issues there. If you run this in other DB configs, I would like to hear from you about it.</p></section><section class="chapter"><h2 id="known-issues" data-toc="known-issues">Known Issues</h2><p id="986630c8_18490">For a while during the evolution of Hive 3, there was a separate 'catalog' for Spark. The queries in this process do NOT consider this alternate catalog and may yield cross products in some areas if the 'spark' catalog was used at any point. Even though this tool was designed for Hive 1 and 2 in mind, it can be run against Hive 3. We do NOT include criteria regarding the 'catalog'.</p></section><section class="chapter"><h2 id="assumptions" data-toc="assumptions">Assumptions</h2><ul class="list _ul" id="986630c8_18491"    ><li class="list__item" id="986630c8_18492"><p>Ran from a node on the cluster </p><ul class="list _ul" id="986630c8_18493"    ><li class="list__item" id="986630c8_18494"><p>That includes clients and configuration files for HDFS</p></li></ul></li><li class="list__item" id="986630c8_18495"><p>Ran by a user that has READ privileges to all HDFS directories.</p></li><li class="list__item" id="986630c8_18496"><p>If cluster is 'kerberized', the user has a valid Kerberos Ticket 'before' starting the application.</p></li><li class="list__item" id="986630c8_18497"><p>Drivers for the HMS database are available.</p></li><li class="list__item" id="986630c8_18498"><p>The configuration file has been defined</p></li><li class="list__item" id="986630c8_18499"><p>The HMS Metastore DB is on a supported RDBMS for the platform (version matters!)</p></li></ul></section><section class="chapter"><h2 id="application-help" data-toc="application-help">Application Help</h2><div class="code-block" data-lang="none"         >
usage: hive-sre u3|sre|perf -cdh|-hdp2|-hdp3|-all|-i &lt;proc[,proc...]&gt; [options]
                version:2.4.0.24.0-SNAPSHOT
Hive SRE Utility
 -all,--all-reports                            Run ALL available processes.
 -cdh,--cloudera-data-hub                      Run processes that make sense for CDH.
 -cfg,--config &lt;arg&gt;                           Config with details for the Sre Job.  Must match the
                                               either sre or u3 selection. Default:
                                               $HOME/.hive-sre/cfg/default.yaml
 -db,--database &lt;arg&gt;                          Comma separated list of Databases.  Will override
                                               config. (upto 100)
 -dbRegEx,--database-regex &lt;arg&gt;               A RegEx of databases to process
 -dp,--decrypt-password &lt;encrypted-password&gt;   Used this in conjunction with '-pkey' to decrypt the
                                               generated passcode from `-p`.
 -edbRegEx,--exclude-database-regex &lt;arg&gt;      A RegEx that will filter OUT matching databases from
                                               processing
 -h,--help                                     Help
 -hdp2,--hortonworks-data-platfrom-v2          Run processes that make sense for HDP2.
 -hdp3,--hortonworks-data-platfrom-v3          Run processes that make sense for HDP3.
 -hfw,--hive-framework &lt;arg&gt;                   The custom HiveFramework check configuration. Needs
                                               to be in the 'Classpath'.
 -i,--include &lt;arg&gt;                            Comma separated list of process id's to run.  When
                                               not specified, ALL processes are run.
 -o,--output-dir &lt;arg&gt;                         Output Directory to save results from Sre.
 -p,--password &lt;password&gt;                      Used this in conjunction with '-pkey' to generate the
                                               encrypted password that you'll add to the configs for
                                               the JDBC connections.
 -pkey,--password-key &lt;password-key&gt;           The key used to encrypt / decrypt the cluster jdbc
                                               passwords.  If not present, the passwords will be
                                               processed as is (clear text) from the config file.
 -scc,--skip-command-checks                    Don't process the command checks for the process.
 -tsql,--test-sql                              Check SQL against target Metastore RDBMS

Visit https://github.com/cloudera-labs/hive-sre for detailed docs
</div><p id="986630c8_18501">To limit which process runs, use the <code class="code" id="986630c8_18502">-i</code> (include) option at the command line with a comma separated list of ids (below) of desired processes.</p></section><section class="chapter"><h2 id="u3-processes" data-toc="u3-processes">u3 Processes</h2><div class="table-wrapper" ><table class="wide" id="986630c8_18503"  ><thead><tr class="ijRowHead" id="986630c8_18504"><th id="986630c8_18505"><p>id (link to sample report)</p></th><th id="986630c8_18506"><p>process</p></th></tr></thead><tbody ><tr id="986630c8_18507"><td id="986630c8_18508"><p><a href="hive-sre-u3-loc-scan-missing-dirs.html" id="986630c8_18509" data-tooltip="truncated for brevity..."  >1</a></p></td><td id="986630c8_18510"><p>Table / Partition Location Scan - Missing Directories</p></td></tr><tr id="986630c8_18511"><td id="986630c8_18512"><p><a href="hive-sre-u3-bad-filenames-for-orc-conversion.html" id="986630c8_18513" data-tooltip="File naming conventions that could prevent a 'managed' ORC table from transitioning to an 'ACID' table"  >2</a></p></td><td id="986630c8_18514"><p>Table / Partition Location Scan - Bad ACID ORC Filenames</p></td></tr><tr id="986630c8_18515"><td id="986630c8_18516"><p><a href="hive-sre-u3-managed-upgrade-2-acid.html" id="986630c8_18517" data-tooltip="Managed Upgrade 2 ACID Hive 3 Upgrade Checks - Managed Non-ACID to ACID Table Migrations -- Table is owned by 'dstreev', not 'hive', and NOT currently ACID. -- This table 'could' be migrated to an ACID table unless changed. -- Recommend forcing the manual conversion to ensure table&hellip;"  >3</a></p></td><td id="986630c8_18518"><p>Hive 3 Upgrade Checks - Managed Non-ACID to ACID Table Migrations</p></td></tr><tr id="986630c8_18519"><td id="986630c8_18520"><p><a href="hive-sre-u3-managed-compactions.html" id="986630c8_18521" data-tooltip="Managed Compactions -- Hive 3 - Compaction Check ALTER TABLE covid_ga.county_cases_archive PARTITION (year_month=&quot;RUN_1&quot;) COMPACT &quot;MAJOR&quot;; ALTER TABLE covid_ga.county_cases_archive PARTITION (year_month=&quot;2020-08&quot;) COMPACT &quot;MAJOR&quot;; ALTER TABLE&hellip;"  >4</a></p></td><td id="986630c8_18522"><p>Hive 3 Upgrade Checks - Compaction Check</p></td></tr><tr id="986630c8_18523"><td id="986630c8_18524"><p><a href="hive-sre-u3-hms-checks.html" id="986630c8_18525" data-tooltip="Listed tables should be review to ensure the Serde is still available. Missing Serde's can disrupt a Hive Upgrade/Migration Process"  >5</a></p></td><td id="986630c8_18526"><p>Hive Metastore Check </p><br><p> - Questionable Serde's Check</p><br><p> - Questionable Serde's Check</p><br><p> - Leagcy Kudu Serde Report</p><br><p> - Legacy Decimal Scale/Precision Check</p><br><p> - List Databases with Table/Partition Counts</p></td></tr><tr id="986630c8_18532"><td id="986630c8_18533"><p><a href="hive-sre-u3-acid-bucketing-update.html" id="986630c8_18534" data-tooltip="ACID Bucket Version Update -- Basic Processing (Skip Command Check specified) ALTER TABLE default.legacy_acid_01 SET TBLPROPERTIES('bucketing_version'='2'); ALTER TABLE tpcds_bin_partitioned_orc_10.call_center_acid SET TBLPROPERTIES('bucketing_version'='2'); ALTER TABLE&hellip;"  >6</a></p></td><td id="986630c8_18535"><p>Provide Script for ACID tables missing the 'bucketing_version' property</p></td></tr></tbody ></table ></div></section><section class="chapter"><h2 id="running" data-toc="running">Running</h2><p id="986630c8_18536">Run the <span class="control" id="986630c8_18537">Hive Metastore Checks</span> Report first (<code class="code" id="986630c8_18538">-i 5</code>) to get a list of databases with table and partition counts. With this information, you can develop a strategy to run the tool in parts using the <code class="code" id="986630c8_18539">-db</code> option. Multi-tasking can be controlled in the configuration files <code class="code" id="986630c8_18540">parallelism</code> setting.</p><p id="986630c8_18541">To ease the launch of the application below, configure these core environment variables.</p></section><section class="chapter"><h2 id="output" data-toc="output">Output</h2><p id="986630c8_18542">The output is a set of files with actions and error (when encountered). The files maybe <code class="code" id="986630c8_18543">txt</code> files or <code class="code" id="986630c8_18544">markdown</code>. You may want to use a <code class="code" id="986630c8_18545">markdown</code> viewer for easier viewing of those reports. The markdown viewer needs to support <a href="https://github.com/adam-p/markdown-here/wiki/Markdown-Cheatsheet#tables" id="986630c8_18546"   data-external="true" rel="noopener noreferrer" >github markdown tables</a>.</p><section class="chapter"><h3 id="examples" data-toc="examples">Examples</h3><p id="986630c8_18547">All command assume the config file is here: <code class="code" id="986630c8_18548">$HOME/.hive-sre/cfg/default.yaml</code></p><p id="986630c8_18549"><span class="emphasis" id="986630c8_18550">All Hive Databases</span> - Will run processes relevant to <code class="code" id="986630c8_18551">cdh</code>.</p><div class="code-block" data-lang="none"         >
hive-sre u3 -cdh -o ./sre-out
</div><p id="986630c8_18553"><span class="emphasis" id="986630c8_18554">Targeted Hive Database</span> - Will run ALL processes on the 'priv_dstreev' hive database and run only reports relative to <code class="code" id="986630c8_18555">hdp2</code>.</p><div class="code-block" data-lang="none"         >
hive-sre u3 -db priv_dstreev -hdp2 -o ./sre-out
</div><p id="986630c8_18557"><span class="emphasis" id="986630c8_18558">Run ONLY compaction check on All Hive Database</span> - Using the <code class="code" id="986630c8_18559">-i</code> option to run only the 'compaction check' sub routine.</p><div class="code-block" data-lang="none"         >
hive-sre u3 -o ./sre-out -i 4
</div></section></section><section class="chapter"><h2 id="check-and-validations-performed" data-toc="check-and-validations-performed">Check and Validations Performed</h2><p id="986630c8_18561">NO action is taken by this process. The output of each section will contain 'actions' for you to take when a scenario materializes. It is up to you to carry out those actions after reviewing them.</p><ol class="list _decimal" id="986630c8_18562"  type="1"  ><li class="list__item" id="986630c8_18563"><p id="986630c8_18564">Hive 3 Upgrade Checks - Locations Scan</p><ul class="list _ul" id="986630c8_18565"    ><li class="list__item" id="986630c8_18566"><p>Missing Directories</p></li></ul><aside class="prompt" data-type="tip" data-title="" id="986630c8_18567"><p id="986630c8_18568">Missing Directories cause the upgrade conversion process to fail. To prevent that failure, there are two choices for a 'missing directory'. Either create it of drop the table/partition.</p></aside><ul class="list _ul" id="986630c8_18569"    ><li class="list__item" id="986630c8_18570"><p>You have two choices based on the output of this process. </p><ul class="list _ul" id="986630c8_18571"    ><li class="list__item" id="986630c8_18572"><p>RECOMMENDED: Drop the table/partition OR</p></li><li class="list__item" id="986630c8_18573"><p>Create the missing directory referenced by the table/partition (empty directories have been known to cause hive table CBO issues, leading to performance slowdowns).</p></li></ul></li><li class="list__item" id="986630c8_18574"><p>The output file from this process will provide commands to accomplish which ever direction you choose. Use 'hive' to run the sql statements. Use <a href="https://github.com/dstreev/hadoop-cli" id="986630c8_18575"   data-external="true" rel="noopener noreferrer" >hadoopcli</a> to run the 'hdfs' commands in bulk.</p></li></ul></li><li class="list__item" id="986630c8_18576"><p id="986630c8_18577">Hive 3 Upgrade Checks - Bad ORC Filenames</p><ul class="list _ul" id="986630c8_18578"    ><li class="list__item" id="986630c8_18579"><p>Bad Filename Format</p></li></ul><aside class="prompt" data-type="tip" data-title="" id="986630c8_18580"><p id="986630c8_18581">Tables that would be convert from a Managed Non-Acid table to an ACID transactional table require the files to match a certain pattern. This process will scan the potential directories of these tables for bad filename patterns. When located, it will indicate which tables/partitions have been file naming conventions that would prevent a successful conversion to ACID. The best and easiest way to correct these files names is to use HiveSQL to rewrite the contents of the table/partition with a simple 'INSERT OVERWRITE TABLE xxx SELECT * FROM xxx'. This type of statement will replace the current bad filenames with valid file names by rewriting the contents in HiveSQL.</p></aside></li><li class="list__item" id="986630c8_18582"><p id="986630c8_18583">Hive 3 Upgrade Checks - Managed Table Migrations</p><ul class="list _ul" id="986630c8_18584"    ><li class="list__item" id="986630c8_18585"><p>Ownership Check</p></li><li class="list__item" id="986630c8_18586"><p>Conversion to ACID tables</p></li></ul><aside class="prompt" data-type="tip" data-title="" id="986630c8_18587"><p id="986630c8_18588">This process will list tables that will and 'could' be migrated to &quot;Managed ACID&quot; tables during the upgrade process. If these tables are used by Spark OR data is managed by a separate process that interacts with the FileSystem, DO NOT LET THESE conversion happen. The output of this process will supply Hive DDL commands to convert these tables to &quot;EXTERNAL / PURGE&quot; tables in Hive 3, which is the same as the 'classic' Hive 1/2 Managed Non-Acid table.</p></aside></li><li class="list__item" id="986630c8_18589"><p id="986630c8_18590">Hive 3 Upgrade Checks - Compaction Check</p><ul class="list _ul" id="986630c8_18591"    ><li class="list__item" id="986630c8_18592"><p>Compaction Check</p></li></ul><aside class="prompt" data-type="tip" data-title="" id="986630c8_18593"><p id="986630c8_18594">Review ACID tables for 'delta' directories. Where 'delta' directories are found, we'll</p></aside></li><li class="list__item" id="986630c8_18595"><p id="986630c8_18596">Metastore Report</p><ul class="list _ul" id="986630c8_18597"    ><li class="list__item" id="986630c8_18598"><p>Questionable Serde's Check</p></li></ul><aside class="prompt" data-type="tip" data-title="" id="986630c8_18599"><p id="986630c8_18600">Will list tables using SERDE's that are not standard to the platform.</p></aside><ul class="list _ul" id="986630c8_18601"    ><li class="list__item" id="986630c8_18602"><p id="986630c8_18603">Action here either:</p><ul class="list _ul" id="986630c8_18604"    ><li class="list__item" id="986630c8_18605"><p>Remove the table using the SERDE, if the SERDE isn't available</p></li><li class="list__item" id="986630c8_18606"><p>Ensure the SERDE is available during the upgrade so table can be evaluated.</p></li></ul></li><li class="list__item" id="986630c8_18607"><p id="986630c8_18608">Legacy Kudu Serde Report</p><aside class="prompt" data-type="tip" data-title="" id="986630c8_18609"><p id="986630c8_18610">Early versions of Hive/Impala tables using Kudu were built before Kudu became an Apache Project. Once it became an Apache Project, the base Kudu Storage Handler classname changed. This report locates and reports on tables using the legacy storage handler class.</p></aside></li><li class="list__item" id="986630c8_18611"><p id="986630c8_18612">Legacy Decimal Scale and Precision Check</p><aside class="prompt" data-type="tip" data-title="" id="986630c8_18613"><p id="986630c8_18614">When the <code class="code" id="986630c8_18615">DECIMAL</code> data type was first introduced in Hive 1, it did NOT include a Scale or Precision element. This causes issues in later integration with Hive and Spark. We'll identify and suggest corrective action for tables where this condition exists.</p></aside></li><li class="list__item" id="986630c8_18616"><p id="986630c8_18617">Managed Table Shadows</p></li></ul><aside class="prompt" data-type="tip" data-title="" id="986630c8_18618"><p id="986630c8_18619">In Hive 3, Managed tables are 'ACID' tables. Sharing a location between two 'ACID' tables will cause compaction issues and data issues. These need to be resolved before the upgrade.</p></aside><ul class="list _ul" id="986630c8_18620"    ><li class="list__item" id="986630c8_18621"><p>Database / Table and Partition Counts</p></li></ul><aside class="prompt" data-type="tip" data-title="" id="986630c8_18622"><p id="986630c8_18623">Use this to understand the scope of what is in the metastore.</p></aside></li></ol></section><section class="chapter"><h2 id="getting-ready-for-a-hive-1-2-to-hive-3-upgrade" data-toc="getting-ready-for-a-hive-1-2-to-hive-3-upgrade">Getting Ready for a Hive 1/2 to Hive 3 Upgrade</h2><p id="986630c8_18624">The reports created by this application will provide you with a prescriptive set of actions that will prepare and accelerate the Hive 1/2 to Hive 3 upgrade.</p><p id="986630c8_18625">Hive consists of two parts: Metadata and Data. Since these are not strictly linked, they do get out of sync. The process 'Location Scans' above finds tables and partitions that don't have a matching file system location. Use the details of this report to 'clean up' the metastore and filesystem.</p><p id="986630c8_18626">Use the reports and scripts provided to build a plan for your upgrade. The latest versions of <code class="code" id="986630c8_18627">u3</code> will create a file called <code class="code" id="986630c8_18628">hsmm_includelist.yaml</code>. This contains a list of Databases and Tables that need attention. Use the contents of this list to choose the actions you'll take for the upgrade. The choices are:</p><ul class="list _ul" id="986630c8_18629"    ><li class="list__item" id="986630c8_18630"><p>Run the HiveStrictManagedMigration process against these targeted database and tables to avoid its default iteration over ALL DB's and tables.</p></li><li class="list__item" id="986630c8_18631"><p>Run the scripts suggested by the reports to migrate your tables. NOTE: Scripts aren&rsquo;t included to address legacy Kudu storage handler classes (CDH Only). Run the HSMM process on those DB&rsquo;s and Tables identified in the report.</p></li></ul><p id="986630c8_18632">Note that the HiveStrictManagedMigration process DOES make adjustments to database definitions as a part of the upgrade. The CDP upgrade docs will include examples on how to ensure that process is run against the DB's and not any tables, to minimize the time in that process.</p></section><div class="last-modified"> Last modified: 06 November 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="hive-sre-sub-commands.html">Sub-Commands</a>   <a class="navigation-links__next" href="to-cdp.html">Upgrading to CDP</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.1.5-b176/app.js"></script></body></html>