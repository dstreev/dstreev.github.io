<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="built-on" content="2024-08-16T16:47:12.185944"><title>Optimizations | hms-mirror</title><script type="application/json" id="virtual-toc-data">[{"id":"controlling-the-yarn-queue-that-runs-the-sql-queries-from-hms-mirror","level":0,"title":"Controlling the YARN Queue that runs the SQL queries from hms-mirror","anchor":"#controlling-the-yarn-queue-that-runs-the-sql-queries-from-hms-mirror"},{"id":"make-backups-before-running-hms-mirror","level":0,"title":"Make Backups before running hms-mirror","anchor":"#make-backups-before-running-hms-mirror"},{"id":"isolate-migration-activities","level":0,"title":"Isolate Migration Activities","anchor":"#isolate-migration-activities"},{"id":"speed-up-create-alter-table-statements-with-existing-data","level":0,"title":"Speed up CREATE/ALTER Table Statements - with existing data","anchor":"#speed-up-create-alter-table-statements-with-existing-data"},{"id":"turn-on-hms-partition-discovery","level":0,"title":"Turn ON HMS partition discovery","anchor":"#turn-on-hms-partition-discovery"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.10.0-b408/app.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Optimizations | hms-mirror"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="hms-mirror Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/hms-mirror/v2.2.0.x/hms-mirror-optimizations.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Optimizations | hms-mirror"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/hms-mirror/v2.2.0.x/hms-mirror-optimizations.html#webpage",
    "url": "writerside-documentation/hms-mirror/v2.2.0.x/hms-mirror-optimizations.html",
    "name": "Optimizations | hms-mirror",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/hms-mirror/#website",
    "url": "writerside-documentation/hms-mirror/",
    "name": "hms-mirror Help"
}</script><!-- End Schema.org --></head><body data-id="hms-mirror-optimizations" data-main-title="Optimizations" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="hms-mirror-running.md|Running"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>hms-mirror v2.2.0.x Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="hms-mirror-optimizations" id="hms-mirror-optimizations.md">Optimizations</h1><p id="z5uzewk_3">Moving metadata and data between two clusters is a pretty straightforward process but depends entirely on the proper configurations in each cluster. Listed here are a few tips on some crucial configurations.</p><p id="z5uzewk_4">HMS-Mirror only moves data with the <a href="sql.html" id="z5uzewk_10" data-tooltip="The SQL data strategy will use Hive SQL to move data between clusters. When the cluster don't have direct line of sight to each other and can NOT be linked, you can use options like -cs or -is to bridge the gap.">SQL</a> and <a href="export-import.html" id="z5uzewk_11" data-tooltip="We'll use EXPORT_IMPORT to get the data to the new cluster. The default behavior requires the clusters to be linked.">EXPORT_IMPORT</a> data strategies. All other strategies either use the data as-is (<a href="linked.html" id="z5uzewk_12" data-tooltip="Assumes the clusters are linked. We'll transfer the schema and leave the location as is on the new cluster.">LINKED</a> or <a href="common.html" id="z5uzewk_13" data-tooltip="The data storage is shared between the two clusters, and no data migration is required.">COMMON</a>) or depend on the data being moved by something like <code class="code" id="z5uzewk_14">distcp</code>.</p><section class="chapter"><h2 id="controlling-the-yarn-queue-that-runs-the-sql-queries-from-hms-mirror" data-toc="controlling-the-yarn-queue-that-runs-the-sql-queries-from-hms-mirror">Controlling the YARN Queue that runs the SQL queries from <code class="code" id="z5uzewk_19">hms-mirror</code></h2><p id="z5uzewk_16">Use the jdbc url defined in <code class="code" id="z5uzewk_20">default.yaml</code> to set a queue.</p><p id="z5uzewk_17"><code class="code" id="z5uzewk_21">jdbc:hive2://host:10000/.....;...?tez.queue.name=batch</code></p><p id="z5uzewk_18">The commandline properties <code class="code" id="z5uzewk_22">-po</code>, <code class="code" id="z5uzewk_23">-pol</code>, and <code class="code" id="z5uzewk_24">-por</code> can be used to override the queue name as well. For example: <code class="code" id="z5uzewk_25">-pol tez.queue.name=batch</code> will set the queue for the &quot;LEFT&quot; cluster while <code class="code" id="z5uzewk_26">-por tez.queue.name=migration</code> will set the queue for the &quot;RIGHT&quot; cluster.</p></section><section class="chapter"><h2 id="make-backups-before-running-hms-mirror" data-toc="make-backups-before-running-hms-mirror">Make Backups before running <code class="code" id="z5uzewk_30">hms-mirror</code></h2><p id="z5uzewk_28">Take snapshots of areas you'll touch:</p><ul class="list _bullet" id="z5uzewk_29"><li class="list__item" id="z5uzewk_31"><p id="z5uzewk_33">The HMS database on the LEFT and RIGHT clusters</p></li><li class="list__item" id="z5uzewk_32"><p id="z5uzewk_34">A snapshot of the HDFS directories on BOTH the LEFT and RIGHT clusters will be used/touched.</p><aside class="prompt" data-type="tip" data-title="" id="z5uzewk_35"><p id="z5uzewk_36">NOTE: If you are testing and &quot;DROPPING&quot; dbs, Snapshots of those data directories could protect you from accidental deletions if you don't manage purge options correctly. Don't skip this... A snapshot of the db directory on HDFS will prevent <code class="code" id="z5uzewk_37">DROP DATABASE x CASCADE</code> from removing the DB directory (observed in CDP 7.1.4+ as tested, check your version) and all sub-directories even though tables were NOT configured with <code class="code" id="z5uzewk_38">purge</code> options.</p></aside></li></ul></section><section class="chapter"><h2 id="isolate-migration-activities" data-toc="isolate-migration-activities">Isolate Migration Activities</h2><p id="z5uzewk_39">The migration of schemas can put a heavy load on HS2 and the HMS server it's using. That impact can manifest itself as 'pauses' for other clients trying to run queries. Extended schema/discovery operations have a 'blocking' tendency in HS2.</p><p id="z5uzewk_40">To prevent average user operational impact, I suggest establishing an isolated HMS and HS2 environment for the migration process.</p><figure id="z5uzewk_41"><img alt="Isolate Migration Service Endpoints" src="images/isolation.png" title="Isolate Migration Service Endpoints" width="1048" height="658"></figure></section><section class="chapter"><h2 id="speed-up-create-alter-table-statements-with-existing-data" data-toc="speed-up-create-alter-table-statements-with-existing-data">Speed up CREATE/ALTER Table Statements - with existing data</h2><p id="z5uzewk_42">Set <code class="code" id="z5uzewk_47">ranger.plugin.hive.urlauth.filesystem.schemes=file</code> in the Hive Server 2(hive_on_tez) Ranger Plugin Safety Value, via Cloudera Manager.</p><figure id="z5uzewk_43"><img alt="Safety Value" src="images/hs2_ranger_schemas.png" title="Safety Value" width="1544" height="552"></figure><p id="z5uzewk_44">Add this to the HS2 instance on the RIGHT cluster when Ranger is used for Auth. This skips the check done against every directory at the table location (for CREATE or ALTER LOCATION). It is allowing the process of CREATE/ALTER to run much faster.</p><p id="z5uzewk_45">The default (true) behavior works well for the interactive use case. Still, bulk operations like this can take a long time if this validation needs to happen for every new partition during creation or discovery.</p><p id="z5uzewk_46">I recommend turning this back after the migration is complete. This setting exposes permissions issues at the time of CREATE/ALTER. So by skipping this, future access issues may arise if the permissions aren't aligned, which isn't a Ranger/Hive issue, it's a permissions issue.</p></section><section class="chapter"><h2 id="turn-on-hms-partition-discovery" data-toc="turn-on-hms-partition-discovery">Turn ON HMS partition discovery</h2><p id="z5uzewk_48">In CDP 7.1.4 and below, the housekeeping threads in HMS used to discover partitions are NOT running. Add <code class="code" id="z5uzewk_51">metastore.housekeeping.threads.on=true</code> to the HMS Safety Value to activate the partition discovery thread. Once this has been set, the following parameters can be used to modify the default behavior.</p><div class="code-block" data-lang="none">
hive.metastore.partition.management.task.frequency
hive.exec.input.listing.max.threads
hive.load.dynamic.partitions.thread
hive.metastore.fshandler.threads 
</div><section class="chapter"><h3 id="source-reference" data-toc="source-reference">Source Reference</h3><div class="code-block" data-lang="none">
    METASTORE_HOUSEKEEPING_LEADER_HOSTNAME(&quot;metastore.housekeeping.leader.hostname&quot;,
            &quot;hive.metastore.housekeeping.leader.hostname&quot;, &quot;&quot;,
&quot;If multiple Thrift metastore services are running, the hostname of Thrift metastore &quot; +
        &quot;service to run housekeeping tasks at. By default, this value is empty, which &quot; +
        &quot;means that the current metastore will run the housekeeping tasks. If configuration&quot; +
        &quot;metastore.thrift.bind.host is set on the intended leader metastore, this value should &quot; +
        &quot;match that configuration. Otherwise it should be same as the hostname returned by &quot; +
        &quot;InetAddress#getLocalHost#getHostName(). Given the uncertainty in the later &quot; +
        &quot;it is desirable to configure metastore.thrift.bind.host on the intended leader HMS.&quot;),
    METASTORE_HOUSEKEEPING_THREADS_ON(&quot;metastore.housekeeping.threads.on&quot;,
        &quot;hive.metastore.housekeeping.threads.on&quot;, false,
        &quot;Whether to run the tasks under metastore.task.threads.remote on this metastore instance or not.\n&quot; +
            &quot;Set this to true on one instance of the Thrift metastore service as part of turning\n&quot; +
            &quot;on Hive transactions. For a complete list of parameters required for turning on\n&quot; +
            &quot;transactions, see hive.txn.manager.&quot;),
</div><p id="z5uzewk_53">The default batch size for partition discovery via <code class="code" id="z5uzewk_54">msck</code> is 3000. Adjustments to this can be made via the <code class="code" id="z5uzewk_55">hive.msck.repair.batch.size</code> property in HS2.</p></section></section><div class="last-modified">Last modified: 16 August 2024</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="hms-mirror-running.html" class="navigation-links__prev">Running</a><a href="hms-mirror-tips.html" class="navigation-links__next">Tips</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.10.0-b408/app.js"></script></body></html>