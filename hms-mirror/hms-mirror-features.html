<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex">  <meta name="built-on" content="2023-11-07T07:59:19.181209"><meta name="build-number" content="${buildNumber}">       <title>Features | hms-mirror</title><script id="virtual-toc-data" type="application/json">[{"id":"iceberg-table-migration-via-hive","level":0,"title":"Iceberg Table Migration via Hive","anchor":"#iceberg-table-migration-via-hive"},{"id":"file-system-stats","level":0,"title":"File System Stats","anchor":"#file-system-stats"},{"id":"create-external-table-if-not-exists-option","level":0,"title":"CREATE EXTERNAL TABLE IF NOT EXISTS Option","anchor":"#create-external-table-if-not-exists-option"},{"id":"auto-gathering-stats-disabled-by-default","level":0,"title":"Auto Gathering Stats (disabled by default)","anchor":"#auto-gathering-stats-disabled-by-default"},{"id":"non-standard-partition-locations","level":0,"title":"Non-Standard Partition Locations","anchor":"#non-standard-partition-locations"},{"id":"optimizations","level":0,"title":"Optimizations","anchor":"#optimizations"},{"id":"hdp3-managedlocation-database-property","level":0,"title":"HDP3 MANAGEDLOCATION Database Property","anchor":"#hdp3-managedlocation-database-property"},{"id":"compress-text-output","level":0,"title":"Compress Text Output","anchor":"#compress-text-output"},{"id":"views","level":0,"title":"VIEWS","anchor":"#views"},{"id":"acid-tables","level":0,"title":"ACID Tables","anchor":"#acid-tables"},{"id":"intermediate-common-storage-options","level":0,"title":"Intermediate/Common Storage Options","anchor":"#intermediate-common-storage-options"},{"id":"non-native-hive-tables-hbase-kafka-jdbc-druid-etc","level":0,"title":"Non-Native Hive Tables (Hbase, KAFKA, JDBC, Druid, etc..)","anchor":"#non-native-hive-tables-hbase-kafka-jdbc-druid-etc"},{"id":"avro-tables","level":0,"title":"AVRO Tables","anchor":"#avro-tables"},{"id":"table-translations","level":0,"title":"Table Translations","anchor":"#table-translations"},{"id":"distcp-planning-workbook-and-scripts","level":0,"title":"distcp Planning Workbook and Scripts","anchor":"#distcp-planning-workbook-and-scripts"},{"id":"acid-table-downgrades","level":0,"title":"ACID Table Downgrades","anchor":"#acid-table-downgrades"},{"id":"reset-to-default-locations","level":0,"title":"Reset to Default Locations","anchor":"#reset-to-default-locations"},{"id":"legacy-row-serde-translations","level":0,"title":"Legacy Row Serde Translations","anchor":"#legacy-row-serde-translations"},{"id":"filtering-tables-to-process","level":0,"title":"Filtering Tables to Process","anchor":"#filtering-tables-to-process"},{"id":"migrations-between-clusters-without-line-of-site","level":0,"title":"Migrations between Clusters WITHOUT line of Site","anchor":"#migrations-between-clusters-without-line-of-site"},{"id":"shared-storage-models-isilon-spectrum-scale-etc","level":0,"title":"Shared Storage Models (Isilon, Spectrum-Scale, etc.)","anchor":"#shared-storage-models-isilon-spectrum-scale-etc"},{"id":"disconnected-mode","level":0,"title":"Disconnected Mode","anchor":"#disconnected-mode"},{"id":"no-purge-option","level":0,"title":"No-Purge Option","anchor":"#no-purge-option"},{"id":"property-overrides","level":0,"title":"Property Overrides","anchor":"#property-overrides"},{"id":"global-location-map","level":0,"title":"Global Location Map","anchor":"#global-location-map"},{"id":"force-external-locations","level":0,"title":"Force External Locations","anchor":"#force-external-locations"},{"id":"hdp-3-hive","level":0,"title":"HDP 3 Hive","anchor":"#hdp-3-hive"},{"id":"schema-fix-features","level":0,"title":"Schema Fix Features","anchor":"#schema-fix-features"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.1.5-b176/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Features | hms-mirror"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="hms-mirror Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="hms-mirrorhms-mirror-features.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Features | hms-mirror"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "hms-mirrorhms-mirror-features.html#webpage", "url": "hms-mirrorhms-mirror-features.html", "name": "Features | hms-mirror", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "hms-mirror/#website", "url": "hms-mirror/", "name": "hms-mirror Help" }</script><!-- End Schema.org --> <!-- Mermaid light/dark themes -->  <link rel="stylesheet" type="text/css" href="mermaid.css">  </head>     <body data-id="hms-mirror-features" data-main-title="Features" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs=""  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>hms-mirror  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="hms-mirror-features"  id="hms-mirror-features.md"  >Features</h1>  <p id="fb1b83a8_80987"><code class="code" id="fb1b83a8_80988">hms-mirror</code> is designed to migrate schema definitions from one cluster to another or simply provide an extract of the schemas via <code class="code" id="fb1b83a8_80989">-d DUMP</code>.</p><p id="fb1b83a8_80990">Under certain conditions, <code class="code" id="fb1b83a8_80991">hms-mirror</code> will 'move' data too. Using the data strategies <code class="code" id="fb1b83a8_80992">-d SQL|EXPORT_IMPORT|HYBRID</code> well use a combination of SQL temporary tables and <a href="linking-cluster-storage-layers.html" id="fb1b83a8_80993" data-tooltip="For the hms-mirror process to work, it relies on the RIGHT clusters' ability to SEE and ACCESS data in the LEFT clusters HDFS namespace. This is the same access/configuration required to support DISTCP for an HA environment and accounts for failovers."  >Linking Clusters Storage Layers</a> to facilitate this.</p><section class="chapter"><h2 id="iceberg-table-migration-via-hive" data-toc="iceberg-table-migration-via-hive">Iceberg Table Migration via Hive</h2><p id="fb1b83a8_80994">See <a href="iceberg-migration.html" id="fb1b83a8_80995" data-tooltip="This process will look at Hive tables, evaluate if the table is a candidate for migration to Iceberg, and then migrate the table to Iceberg."  >Iceberg Migration</a> for details.</p></section><section class="chapter"><h2 id="file-system-stats" data-toc="file-system-stats">File System Stats</h2><p id="fb1b83a8_80996">SQL based operations, <code class="code" id="fb1b83a8_80997">hms-mirror</code> will attempt to gather file system stats for the tables being migrated. This is done by running <code class="code" id="fb1b83a8_80998">hdfs dfs -count</code> on the table location. This is done to help determine the best strategy for moving data and allows us to set certain hive session values and distribution strategies in SQL to optimize the data movement.</p><p id="fb1b83a8_80999">But some FileSystems may not be very efficient at gathering stats. For example, S3. In these cases, you can disable the stats gathering by adding <code class="code" id="fb1b83a8_81000">-ssc|--skip-stats-collection</code> to your command line.</p><p id="fb1b83a8_81001">When you have a LOT of tables, collecting stats can have a significant impact on the time it takes to run <code class="code" id="fb1b83a8_81002">hms-mirror</code> and the general pressure on the FileSystem to gather this information. In this case, you have to option to disable stats collection through <code class="code" id="fb1b83a8_81003">-scc</code>.</p></section><section class="chapter"><h2 id="create-external-table-if-not-exists-option" data-toc="create-external-table-if-not-exists-option">CREATE EXTERNAL TABLE IF NOT EXISTS Option</h2><p id="fb1b83a8_81004">Default behavior for <code class="code" id="fb1b83a8_81005">hms-mirror</code> is to NOT include the <code class="code" id="fb1b83a8_81006">IF NOT EXISTS</code> clause in the <code class="code" id="fb1b83a8_81007">CREATE TABLE</code> statements. This is because we want to ensure that the table is created and that the schema is correct. If the table already exists, we want to fail.</p><p id="fb1b83a8_81008">But there are some scenarios where the table is present and we don't want the process to fail on the CREATE statement to ensure the remaining SQL statements are executed. In this case, you can modify add the commandline option <code class="code" id="fb1b83a8_81009">-cine</code> or add to the configuration:</p><div class="code-block" data-lang="yaml"         >
  clusters:
    RIGHT|LEFT:
      createIfNotExists: &quot;true&quot;
</div><p id="fb1b83a8_81011">Using this option has the potential to create a table with a different schema than the source. This is not recommended. This option is applied when using the <code class="code" id="fb1b83a8_81012">SCHEMA_ONLY</code> data strategy.</p></section><section class="chapter"><h2 id="auto-gathering-stats-disabled-by-default" data-toc="auto-gathering-stats-disabled-by-default">Auto Gathering Stats (disabled by default)</h2><p id="fb1b83a8_81013">CDP Default settings have enabled <code class="code" id="fb1b83a8_81014">hive.stats.autogather</code> and <code class="code" id="fb1b83a8_81015">hive.stats.column.autogather</code>. This impacts the speed of INSERT statements (used by <code class="code" id="fb1b83a8_81016">hms-mirror</code> to migrate data) and for large/numerous tables, the impact can be significant.</p><p id="fb1b83a8_81017">The default configuration for <code class="code" id="fb1b83a8_81018">hms-mirror</code> is to disable these settings. You can re-enable this in <code class="code" id="fb1b83a8_81019">hms-mirror</code> for each side (LEFT|RIGHT) separately. Add the following to your configuration.</p><div class="code-block" data-lang="yaml"         >
clusters:
  LEFT|RIGHT:
    enableAutoTableStats: true
    enableAutoColumnStats: true
</div><p id="fb1b83a8_81021">To disable, remove the <code class="code" id="fb1b83a8_81022">enableAutoTableStats</code> and <code class="code" id="fb1b83a8_81023">enableAutoColumnStats</code> entries or set them to <code class="code" id="fb1b83a8_81024">false</code>.</p></section><section class="chapter"><h2 id="non-standard-partition-locations" data-toc="non-standard-partition-locations">Non-Standard Partition Locations</h2><p id="fb1b83a8_81025">Partitions created by 'hive' with default locations follow a file system naming convention that allows other partitions of 'hive' to discovery/manage those location and partition associations.</p><p id="fb1b83a8_81026">The standard is for partitions to exist as sub-directories of the table location. For example: Table Location is <code class="code" id="fb1b83a8_81027">hdfs://my-cluster/warehouse/tablespace/external/hive/my_test.db/my_table</code> and the partition location is <code class="code" id="fb1b83a8_81028">hdfs://my-cluster/warehouse/tablespace/external/hive/my_test.db/my_table/dt=2020-01-01</code>, assuming the partition column name is <code class="code" id="fb1b83a8_81029">dt</code>.</p><p id="fb1b83a8_81030">When this convention is not followed, additional steps are required to build the partition metadata. You can't use <code class="code" id="fb1b83a8_81031">MSCK REPAIR</code> because it will not find the partitions. You can use <code class="code" id="fb1b83a8_81032">ALTER TABLE ADD PARTITION</code> but you'll need to provide the location of the partition. <code class="code" id="fb1b83a8_81033">hms-mirror</code> will do this for you when using the data strategies <code class="code" id="fb1b83a8_81034">-d DUMP|SCHEMA_ONLY</code> and the commandline flag <code class="code" id="fb1b83a8_81035">-epl|--evaluate-partition-location</code>.</p><p id="fb1b83a8_81036">In order to make this evaluation efficient, we do NOT use standard HiveSQL to discover the partition details. It is possible to use HiveSQL for this, it's just not meant for operations at scale or tables with a lot of partitions.</p><p id="fb1b83a8_81037">Hence, we tap directly into the hive metastore database. In order to use this feature, you will need to add the following configuration definition to your hms-mirror configuration file (default.yaml).</p><div class="code-block" data-lang="yaml"         >
clusters:
  LEFT|RIGHT:
    ...
    metastore_direct:
      uri: &quot;&lt;db_url&gt;&quot;
      type: MYSQL|POSTGRES|ORACLE
      connectionProperties:
        user: &quot;&lt;db_user&gt;&quot;
        password: &quot;&lt;db_password&gt;&quot;
      connectionPool:
        min: 3
        max: 5
</div><p id="fb1b83a8_81039">You will also need to place a copy of the RDBMS JDBC driver in <code class="code" id="fb1b83a8_81040">$HOME/.hms-mirror/aux_libs</code>. The driver must match the <code class="code" id="fb1b83a8_81041">type</code> defined in the configuration file.</p><p id="fb1b83a8_81042"><span class="control" id="fb1b83a8_81043">Note: Non-Standard Partition Location will affect other strategies like <code class="code" id="fb1b83a8_81044">SQL</code> where the LEFT clusters storage is accessible to the RIGHT and is used by the RIGHT to source data. The 'mirror' table used for the transfer will NOT discover the partitions and will NOT transfer data. See: <a href="https://github.com/cloudera-labs/hms-mirror/issues/63" id="fb1b83a8_81045"   data-external="true" rel="noopener noreferrer" >Issue #63</a> for updates on addressing this scenario. If this is affecting you, I highly recommend you comment on the issue to help us set priorities.</span></p></section><section class="chapter"><h2 id="optimizations" data-toc="optimizations">Optimizations</h2><p id="fb1b83a8_81046">The following configuration settings control the various optimizations taken by <code class="code" id="fb1b83a8_81047">hms-mirror</code>. These settings are mutually exclusive.</p><ul class="list _ul" id="fb1b83a8_81048"    ><li class="list__item" id="fb1b83a8_81049"><p><code class="code" id="fb1b83a8_81050">-at|--auto-tune</code></p></li><li class="list__item" id="fb1b83a8_81051"><p><code class="code" id="fb1b83a8_81052">-so|--skip-optimizations</code></p></li><li class="list__item" id="fb1b83a8_81053"><p><code class="code" id="fb1b83a8_81054">-sdpi|--sort-dynamic-partition-inserts</code></p></li></ul><section class="chapter"><h3 id="auto-tune" data-toc="auto-tune">Auto-Tune</h3><p id="fb1b83a8_81055"><code class="code" id="fb1b83a8_81056">-at|--auto-tune</code></p><p id="fb1b83a8_81057">Auto-tuning will use some basic file level statistics about tables/partitions to provide overrides for the following settings:</p><ul class="list _ul" id="fb1b83a8_81058"    ><li class="list__item" id="fb1b83a8_81059"><p><code class="code" id="fb1b83a8_81060">tez.grouping.max-size</code></p></li><li class="list__item" id="fb1b83a8_81061"><p><code class="code" id="fb1b83a8_81062">hive.exec.max.dynamic.partitions</code></p></li><li class="list__item" id="fb1b83a8_81063"><p><code class="code" id="fb1b83a8_81064">hive.exec.reducers.max</code></p></li></ul><p id="fb1b83a8_81065">in addition to these session level setting, we'll use those basic file statistics to construct migration scripts that address things like 'small-files' and 'large' partition datasets.</p><p id="fb1b83a8_81066">We'll set <code class="code" id="fb1b83a8_81067">hive.optimize.sort.dynamic.partition.threshold=-1</code> and append <code class="code" id="fb1b83a8_81068">DISTRIBUTE BY</code> to the SQL migration sql statement, just like we do with <code class="code" id="fb1b83a8_81069">-sdpi</code>. But we'll go one step further and review the average partition size and add an additional 'grouping' element to the SQL to ensure we get efficient writers to a partition. The means that tables with large partition datasets will have more than the standard single writer per partition, preventing the LONG running hanging task that is trying to write a very large partition.</p></section><section class="chapter"><h3 id="sort-dynamic-partition-inserts" data-toc="sort-dynamic-partition-inserts">Sort Dynamic Partition Inserts</h3><p id="fb1b83a8_81070"><code class="code" id="fb1b83a8_81071">-sdpi|--sort-dynamic-partition-inserts</code></p><p id="fb1b83a8_81072">This will set the session property <code class="code" id="fb1b83a8_81073">hive.optimize.sort.dynamic.partition.threshold=0</code>, which will enable plans to distribute multi partition inserts by the partition key, therefore reducing partitions writes to a single 'writer/reducer'.</p><p id="fb1b83a8_81074">When this isn't set, we set <code class="code" id="fb1b83a8_81075">hive.optimize.sort.dynamic.partition.threshold=-1</code>, and append <code class="code" id="fb1b83a8_81076">DISTRIBUTE BY</code> to the SQL migration sql statement to ensure the same behavior of grouping reducers by partition values.</p></section><section class="chapter"><h3 id="skip-optimizations" data-toc="skip-optimizations">Skip Optimizations</h3><p id="fb1b83a8_81077"><code class="code" id="fb1b83a8_81078">-so</code></p><p id="fb1b83a8_81079"><a href="https://github.com/cloudera-labs/hms-mirror/issues/23" id="fb1b83a8_81080"   data-external="true" rel="noopener noreferrer" >Feature Request #23</a> was introduced in v1.5.4.2 and give an option to <span class="control" id="fb1b83a8_81081">Skip Optimizations</span>.</p><p id="fb1b83a8_81082">When migrating data via SQL with partitioned tables (OR downgrading an ACID table), there are optimizations that we apply to help hive distribute data more efficiently. One method is to use <code class="code" id="fb1b83a8_81083">hive.optimize.sort.dynamic.partition=true</code> which will &quot;DISTRIBUTE&quot; data along the partitions via a Reduction task. Another is to declare this in SQL with a <code class="code" id="fb1b83a8_81084">DISTRIBUTE BY</code> clause.</p><p id="fb1b83a8_81085">But there is a corner case where these optimizations can get in the way and cause long-running tasks. If the source table has already been organized into large files (which would be within the partitions already), adding the optimizations above force a single reducer per partition. If the partitions are large and already have good file sizes, we want to skip these optimizations and let hive run the process with only a map task.</p></section></section><section class="chapter"><h2 id="hdp3-managedlocation-database-property" data-toc="hdp3-managedlocation-database-property">HDP3 MANAGEDLOCATION Database Property</h2><p id="fb1b83a8_81086"><a href="https://github.com/cloudera-labs/hms-mirror/issues/52" id="fb1b83a8_81087"   data-external="true" rel="noopener noreferrer" >HDP3 doesn't support MAANGEDLOCATION</a> so we've added a property to the cluster configuration to allow the system to <span class="emphasis" id="fb1b83a8_81088">SKIP</span> setting the <code class="code" id="fb1b83a8_81089">MANAGEDLOCATION</code> database property in HDP 3 / Hive 3 environments.</p><div class="code-block" data-lang="yaml"         >
clusters:
  LEFT:
    legacyHive: false
    hdpHive3: true
</div></section><section class="chapter"><h2 id="compress-text-output" data-toc="compress-text-output">Compress Text Output</h2><p id="fb1b83a8_81091"><code class="code" id="fb1b83a8_81092">-cto</code> will control the session level setting for `hive.exec.compress.output'.</p></section><section class="chapter"><h2 id="views" data-toc="views">VIEWS</h2><p id="fb1b83a8_81093"><code class="code" id="fb1b83a8_81094">hms-mirror</code> now supports the migration of VIEWs between two environments. Use the <code class="code" id="fb1b83a8_81095">-v|--views-only</code> option to execute this path. VIEW creation requires dependent tables to exist.</p><p id="fb1b83a8_81096">Run <code class="code" id="fb1b83a8_81097">hms-mirror</code> to create all the target tables before running it with the <code class="code" id="fb1b83a8_81098">-v</code> option.</p><p id="fb1b83a8_81099">This flag is an <code class="code" id="fb1b83a8_81100">OR</code> for processing VIEW's <code class="code" id="fb1b83a8_81101">OR</code> TABLE's. They are NOT processed together.</p><p id="fb1b83a8_81102"><span class="control" id="fb1b83a8_81103">Requirements</span></p><ul class="list _ul" id="fb1b83a8_81104"    ><li class="list__item" id="fb1b83a8_81105"><p>The dependent tables must exist in the RIGHT cluster</p></li><li class="list__item" id="fb1b83a8_81106"><p>When using <code class="code" id="fb1b83a8_81107">-dbp|--db-prefix</code> option, VIEW definitions are NOT modified and will most likely cause VIEW creation to fail.</p></li></ul></section><section class="chapter"><h2 id="acid-tables" data-toc="acid-tables">ACID Tables</h2><p id="fb1b83a8_81108"><code class="code" id="fb1b83a8_81109">hms-mirror</code> supports the migration of ACID tables using the <code class="code" id="fb1b83a8_81110">-d HYBRID|SQL|EXPORT_IMPORT</code> data strategy in combination with the <code class="code" id="fb1b83a8_81111">-ma|--migrate-acid</code> or <code class="code" id="fb1b83a8_81112">-mao|--migrate-acid-only</code> flag. You can also simply 'replay' the schema definition (without data) using <code class="code" id="fb1b83a8_81113">-d SCHEMA_ONLY -ma|-mao</code>. The <code class="code" id="fb1b83a8_81114">-ma|-mao</code> flag takes an <span class="emphasis" id="fb1b83a8_81115">optional</span> integer value that sets an 'Artificial Bucket Threshold'. When no parameter is specified, the default is <code class="code" id="fb1b83a8_81116">2</code>.</p><p id="fb1b83a8_81117">Use this value to set a bucket limit where we'll <span class="emphasis" id="fb1b83a8_81118">remove</span> the bucket definition during the translation. This is helpful for legacy ACID tables which <span class="emphasis" id="fb1b83a8_81119">required</span> a bucket definition but weren't a part of the intended design. The migration provides an opportunity to correct this artificial design element.</p><p id="fb1b83a8_81120">With the default value <code class="code" id="fb1b83a8_81121">2</code>, we will <span class="emphasis" id="fb1b83a8_81122">remove</span> CLUSTERING from any ACID table definitions with <code class="code" id="fb1b83a8_81123">2</code> or fewer buckets defined. If you wish to keep ALL CLUSTERED definitions, regardless of size, set this value to <code class="code" id="fb1b83a8_81124">0</code>.</p><p id="fb1b83a8_81125">There is now an option to 'downgrade' ACID tables to EXTERNAL/PURGE during migration using the <code class="code" id="fb1b83a8_81126">-da</code> option.</p><section class="chapter"><h3 id="the-acid-migration-process" data-toc="the-acid-migration-process">The ACID Migration Process</h3><p id="fb1b83a8_81127">The ACID migration builds a 'transfer' table on the LEFT cluster, a 'legacy' managed table (when the LEFT is a legacy cluster), or an 'EXTERNAL/PURGE' table. Data is copied to this transfer table from the original ACID table via SQL.</p><p id="fb1b83a8_81128">Since the clusters are <a href="linking-cluster-storage-layers.html" id="fb1b83a8_81129" data-tooltip="For the hms-mirror process to work, it relies on the RIGHT clusters' ability to SEE and ACCESS data in the LEFT clusters HDFS namespace. This is the same access/configuration required to support DISTCP for an HA environment and accounts for failovers."  >linked</a>, we build a 'shadow' table that is 'EXTERNAL' on the 'RIGHT' cluster that uses the data in the 'LEFT' cluster. Similar to the LINKED data strategy. If the data is partitioned, we run <code class="code" id="fb1b83a8_81130">MSCK</code> on this 'shadow' table in the 'RIGHT' cluster to discover all the partitions.</p><p id="fb1b83a8_81131">The final ACID table is created in the 'RIGHT' cluster, and SQL is used to copy data from the 'LEFT' cluster via the 'shadow' table.</p><p id="fb1b83a8_81132"><span class="control" id="fb1b83a8_81133">Requirements</span></p><ul class="list _ul" id="fb1b83a8_81134"    ><li class="list__item" id="fb1b83a8_81135"><p>Data Strategy: <code class="code" id="fb1b83a8_81136">HYBRID</code>, <code class="code" id="fb1b83a8_81137">SQL</code>, or <code class="code" id="fb1b83a8_81138">EXPORT_IMPORT</code></p></li><li class="list__item" id="fb1b83a8_81139"><p>Activate Migrate ACID: <code class="code" id="fb1b83a8_81140">-ma|-mao</code></p></li><li class="list__item" id="fb1b83a8_81141"><p><a href="linking-cluster-storage-layers.html" id="fb1b83a8_81142" data-tooltip="For the hms-mirror process to work, it relies on the RIGHT clusters' ability to SEE and ACCESS data in the LEFT clusters HDFS namespace. This is the same access/configuration required to support DISTCP for an HA environment and accounts for failovers."  >Link Clusters</a>, unless using the <code class="code" id="fb1b83a8_81143">-is|--intermediate-storage</code> option.</p></li><li class="list__item" id="fb1b83a8_81144"><p>This is a 'ONE' time transfer. It is not an incremental update process.</p></li><li class="list__item" id="fb1b83a8_81145"><p>Adequate Storage on LEFT to make an 'EXTERNAL' copy of the ACID table.</p></li><li class="list__item" id="fb1b83a8_81146"><p>Permissions: </p><ul class="list _ul" id="fb1b83a8_81147"    ><li class="list__item" id="fb1b83a8_81148"><p>From the RIGHT cluster, the submitting user WILL need access to the LEFT cluster's storage layer (HDFS) to create the shadow table (with location) that points across clusters.</p></li><li class="list__item" id="fb1b83a8_81149"><p>doas will have a lot to do with the permissions requirements.</p></li><li class="list__item" id="fb1b83a8_81150"><p>The 'hive' service account on the RIGHT cluster will need elevated privileges to the LEFT storage LAYER (HDFS). For example: If the hive service accounts on each cluster DO NOT share the same identity, like <code class="code" id="fb1b83a8_81151">hive</code>, then the RIGHT hive identity MUST also have privileged access to the LEFT clusters HDFS layer.</p></li></ul></li><li class="list__item" id="fb1b83a8_81152"><p>Partitioned tables must have data that is 'discoverable' via <code class="code" id="fb1b83a8_81153">MSCK</code>. NOTE: The METADATA activity and REDUCER restrictions to the number of BUCKETs can dramatically affect this.- The number of partitions in the source ACID tables must be below the <code class="code" id="fb1b83a8_81154">partitionLimit</code> (default 500). This strategy may not be successful when the partition count is above this, and we won't even attempt the conversion. Check YARN for the progress of jobs with a large number of partitions/buckets. Progress many appear stalled from 'hms-mirror'.</p></li><li class="list__item" id="fb1b83a8_81155"><p>ACID table migration to Hive 1/2 is NOT supported due to the lack of support for &quot;INSERT OVERWRITE&quot; on transactional tables. Hive 1/2 to Hive 3 IS support and the target of this implementation. Hive 3 to Hive 3 is also supported.</p></li></ul></section><section class="chapter"><h3 id="replace-acid-r-or-replace" data-toc="replace-acid-r-or-replace">Replace ACID -r or --replace</h3><p id="fb1b83a8_81156">When downgrading ACID tables during migration, the <code class="code" id="fb1b83a8_81157">-r</code> option will give you the option to 'replace' the original ACID table with the a table that is no longer ACID. This option is only available along with the <code class="code" id="fb1b83a8_81158">-da</code> and <code class="code" id="fb1b83a8_81159">SQL</code> data strategy options.</p></section></section><section class="chapter"><h2 id="intermediate-common-storage-options" data-toc="intermediate-common-storage-options">Intermediate/Common Storage Options</h2><p id="fb1b83a8_81160">When bridging the gap between two clusters, you may find they can't share/link storage. In this case, using one of these options will help you with the transfer.</p><p id="fb1b83a8_81161">The <code class="code" id="fb1b83a8_81162">-is</code> or <code class="code" id="fb1b83a8_81163">--intermediate-storage</code> option is consider a transient location that both cluster can share, see, and have access to. The strategies for transferring data (EXPORT_IMPORT, SQL, HYBRID) will use this location to facilitate the transfer. This is a common strategy when migrating from on-prem environments to the cloud.</p><p id="fb1b83a8_81164">The <code class="code" id="fb1b83a8_81165">-cs</code> or <code class="code" id="fb1b83a8_81166">--common-storage</code> option is similar to <code class="code" id="fb1b83a8_81167">-is</code> but this option ends up being the final resting place for the data, not just the transfer location. And with this option, we can streamline the jumps required to migrate data. Again, this location needs to be accessible to both clusters.</p></section><section class="chapter"><h2 id="non-native-hive-tables-hbase-kafka-jdbc-druid-etc" data-toc="non-native-hive-tables-hbase-kafka-jdbc-druid-etc">Non-Native Hive Tables (Hbase, KAFKA, JDBC, Druid, etc..)</h2><p id="fb1b83a8_81168">Any table definition without a <code class="code" id="fb1b83a8_81169">LOCATION</code> element is typically a reference to an external system like: HBase, Kafka, Druid, and/or (but not limited to) JDBC.</p><p id="fb1b83a8_81170"><span class="control" id="fb1b83a8_81171">Requirements</span></p><p id="fb1b83a8_81172">These references require the environment to be:</p><ul class="list _ul" id="fb1b83a8_81173"    ><li class="list__item" id="fb1b83a8_81174"><p>Correctly configured to use these resources</p></li><li class="list__item" id="fb1b83a8_81175"><p>Include the required libraries in the default hive environment.</p></li><li class="list__item" id="fb1b83a8_81176"><p>The referenced resource must exist already BEFORE the 'hive' DDL will successfully run.</p></li></ul></section><section class="chapter"><h2 id="avro-tables" data-toc="avro-tables">AVRO Tables</h2><p id="fb1b83a8_81177">AVRO tables can be designed with a 'reference' to a schema file in <code class="code" id="fb1b83a8_81178">TBLPROPERTIES</code> with <code class="code" id="fb1b83a8_81179">avro.schema.url</code>. The referenced file needs to be 'copied' to the <span class="emphasis" id="fb1b83a8_81180">RIGHT</span> cluster BEFORE the <code class="code" id="fb1b83a8_81181">CREATE</code> statement for the AVRO table will succeed.</p><p id="fb1b83a8_81182">Add the <code class="code" id="fb1b83a8_81183">-asm|--avro-schema-move</code> option at the command line to <span class="emphasis" id="fb1b83a8_81184">copy</span> the file from the LEFT cluster to the RIGHT cluster.</p><p id="fb1b83a8_81185">As long as the clusters are <a href="linking-cluster-storage-layers.html" id="fb1b83a8_81186" data-tooltip="For the hms-mirror process to work, it relies on the RIGHT clusters' ability to SEE and ACCESS data in the LEFT clusters HDFS namespace. This is the same access/configuration required to support DISTCP for an HA environment and accounts for failovers."  >linked</a> and the cluster <code class="code" id="fb1b83a8_81187">hcfsNamespace</code> values are accurate, the user's credentials running <code class="code" id="fb1b83a8_81188">hms-mirror</code> will attempt to copy the schema file to the <span class="emphasis" id="fb1b83a8_81189">RIGHT</span> cluster BEFORE executing the <code class="code" id="fb1b83a8_81190">CREATE</code> statement.</p><p id="fb1b83a8_81191"><span class="control" id="fb1b83a8_81192">Requirements</span></p><ul class="list _ul" id="fb1b83a8_81193"    ><li class="list__item" id="fb1b83a8_81194"><p><a href="linking-cluster-storage-layers.html" id="fb1b83a8_81195" data-tooltip="For the hms-mirror process to work, it relies on the RIGHT clusters' ability to SEE and ACCESS data in the LEFT clusters HDFS namespace. This is the same access/configuration required to support DISTCP for an HA environment and accounts for failovers."  >Link Clusters</a> for Data Strategies: <code class="code" id="fb1b83a8_81196">SCHEMA_ONLY</code>, <code class="code" id="fb1b83a8_81197">SQL</code>, <code class="code" id="fb1b83a8_81198">EXPORT_IMPORT</code>, and <code class="code" id="fb1b83a8_81199">HYBRID</code></p></li><li class="list__item" id="fb1b83a8_81200"><p>Running user must have 'namespace' access to the directories identified in the <code class="code" id="fb1b83a8_81201">TBLPROPERTIES</code> key <code class="code" id="fb1b83a8_81202">avro.schema.url</code>.</p></li><li class="list__item" id="fb1b83a8_81203"><p>The user running <code class="code" id="fb1b83a8_81204">hms-mirror</code> will need enough storage level permissions to copy the file.</p></li><li class="list__item" id="fb1b83a8_81205"><p>When hive is running with <code class="code" id="fb1b83a8_81206">doas=false</code>, <code class="code" id="fb1b83a8_81207">hive</code> will need access to this file.</p></li></ul><section class="chapter"><h3 id="warnings" data-toc="warnings">Warnings</h3><ul class="list _ul" id="fb1b83a8_81208"    ><li class="list__item" id="fb1b83a8_81209"><p>With the <code class="code" id="fb1b83a8_81210">EXPORT_IMPORT</code> strategy, the <code class="code" id="fb1b83a8_81211">avro.schema.url</code> location will NOT be converted. It may lead to an issue reading the table if the location includes a prefix of the cluster's namespace OR the file doesn't exist in the new cluster.</p></li></ul></section></section><section class="chapter"><h2 id="table-translations" data-toc="table-translations">Table Translations</h2><section class="chapter"><h3 id="legacy-managed-tables" data-toc="legacy-managed-tables">Legacy Managed Tables</h3><p id="fb1b83a8_81212"><code class="code" id="fb1b83a8_81213">hms-mirror</code> will convert 'legacy' managed tables in Hive 1 or 2 to EXTERNAL tables in Hive 3. It relies on the <code class="code" id="fb1b83a8_81214">legacyHive</code> setting in the cluster configurations to accurately make this conversion. So make sure you've set this correctly.</p></section></section><section class="chapter"><h2 id="distcp-planning-workbook-and-scripts" data-toc="distcp-planning-workbook-and-scripts">distcp Planning Workbook and Scripts</h2><p id="fb1b83a8_81215"><code class="code" id="fb1b83a8_81216">hms-mirror</code> will create source files and a shell script that can be used as the basis for the 'distcp' job(s) used to support the databases and tables requested in <code class="code" id="fb1b83a8_81217">-db</code>. <code class="code" id="fb1b83a8_81218">hms-mirror</code> will NOT run these jobs. It will provide the basic job constructs that match what it did for the schemas. Use these constructs to build your execution plan and run these separately.</p><p id="fb1b83a8_81219">The constructs created are intended as a <span class="emphasis" id="fb1b83a8_81220">one-time</span> transfer. If you are using <span class="emphasis" id="fb1b83a8_81221">SNAPSHOTS</span> or <code class="code" id="fb1b83a8_81222">--update</code> flags in <code class="code" id="fb1b83a8_81223">distcp</code> to support incremental updates, you will have to make additional modifications to the scripts/process. Note: For these scenarios, <code class="code" id="fb1b83a8_81224">hms-mirror</code> supports options like <code class="code" id="fb1b83a8_81225">-ro|--read-only</code> and <code class="code" id="fb1b83a8_81226">-sync</code>.</p><p id="fb1b83a8_81227">Each time <code class="code" id="fb1b83a8_81228">hms-mirror</code> is run, <span class="emphasis" id="fb1b83a8_81229">source</span> files for each database are created. These source files need to be copied to the distributed filesystem and reference with an <code class="code" id="fb1b83a8_81230">-f</code> option in <code class="code" id="fb1b83a8_81231">distcp</code>. We also create a <span class="emphasis" id="fb1b83a8_81232">basic</span> shell script that can be used as a template to run the actual <code class="code" id="fb1b83a8_81233">distcp</code> jobs.</p><p id="fb1b83a8_81234">Depending on the job size and operational expectations, you may want to use <span class="emphasis" id="fb1b83a8_81235">SNAPSHOTS</span> to ensure an immutable source or use a <code class="code" id="fb1b83a8_81236">diff</code> strategy for more complex migrations. Regardless, you'll need to make modifications to these scripts to suit your purposes.</p><p id="fb1b83a8_81237">If your process requires the data to exist BEFORE you migrate the schemas, run <code class="code" id="fb1b83a8_81238">hms-mirror</code> in the <code class="code" id="fb1b83a8_81239">dry-run</code> mode (default) and use the distcp planning workbook and scripts to transfer the datasets. Then run <code class="code" id="fb1b83a8_81240">hms-mirror</code> with the <code class="code" id="fb1b83a8_81241">-e|--execute</code> option to migrate the schemas.</p><p id="fb1b83a8_81242">These workbooks will NOT include elements for ACID/Transactional tables. Simply copying the dataset for transactional tables will NOT work. Use the <code class="code" id="fb1b83a8_81243">HYBRID</code> data strategy migration transactional table schemas and datasets.</p></section><section class="chapter"><h2 id="acid-table-downgrades" data-toc="acid-table-downgrades">ACID Table Downgrades</h2><p id="fb1b83a8_81244">The default table creation scenario for Hive 3 (CDP and HDP 3) installations is to create ACID transactional tables. If you're moving from a legacy platform like HDP 2 or CDH, this may have caught you off guard and resulted in a lot of ACID tables you did NOT intend on.</p><p id="fb1b83a8_81245">The <code class="code" id="fb1b83a8_81246">-da|--downgrade-acid</code> option can be used to convert these ACID tables to <span class="emphasis" id="fb1b83a8_81247">EXTERNAL/PURGE</span> tables.</p><p id="fb1b83a8_81248">If you have ACID tables on the current platform and would like to <span class="emphasis" id="fb1b83a8_81249">downgrade</span> them, but you're not doing a migration, try the <code class="code" id="fb1b83a8_81250">-ip|--in-place</code> option. This will archive to existing ACID table and build a new table (with the original table name) that is <span class="emphasis" id="fb1b83a8_81251">EXTERNAL/PURGE</span>.</p></section><section class="chapter"><h2 id="reset-to-default-locations" data-toc="reset-to-default-locations">Reset to Default Locations</h2><p id="fb1b83a8_81252">Migrations present an opportunity to clean up a lot of history. While <code class="code" id="fb1b83a8_81253">hms-mirror</code> was originally designed to migration data and maintain the <span class="control" id="fb1b83a8_81254">relative</span> locations of the data, some may want to reorganize the data during the migration.</p><p id="fb1b83a8_81255">The option <code class="code" id="fb1b83a8_81256">-rdl|--reset-default-location</code> will overwrite the locations originally used and place the datasets in the 'default' locations as defined by <code class="code" id="fb1b83a8_81257">-wd|--warehouse-directory</code> and <code class="code" id="fb1b83a8_81258">-ewd|--external-warehouse-directory</code>.</p><p id="fb1b83a8_81259">The <code class="code" id="fb1b83a8_81260">-rdl</code> option requires <code class="code" id="fb1b83a8_81261">-wd</code> and <code class="code" id="fb1b83a8_81262">-ewd</code> to be specified. These locations will be used to <code class="code" id="fb1b83a8_81263">ALTER</code> the databases <code class="code" id="fb1b83a8_81264">LOCATION</code> and <code class="code" id="fb1b83a8_81265">MANAGEDLOCATION</code> values. After which, all new <code class="code" id="fb1b83a8_81266">CREATE [EXTERNAL] TABLE</code> definitions don't specify a <code class="code" id="fb1b83a8_81267">LOCATION</code>, which means table locations will use the default.</p></section><section class="chapter"><h2 id="legacy-row-serde-translations" data-toc="legacy-row-serde-translations">Legacy Row Serde Translations</h2><p id="fb1b83a8_81268">By default, tables using old row <span class="emphasis" id="fb1b83a8_81269">serde</span> classes will be converted to the newer serde as the definition is processed by <code class="code" id="fb1b83a8_81270">hms-mirror</code>. See <a href="https://github.com/cloudera-labs/hms-mirror/blob/6f6c309f24fbb8133e5bd52e5b18274094ff5be8/src/main/java/com/cloudera/utils/hadoop/hms/mirror/feature/LegacyTranslations.java#L28" id="fb1b83a8_81271"   data-external="true" rel="noopener noreferrer" >here</a> for a list of serdes we look for.</p><p id="fb1b83a8_81272">If you do NOT want to apply this translation, add the option <code class="code" id="fb1b83a8_81273">-slt|--skip-legacy-translation</code> to the commandline.</p></section><section class="chapter"><h2 id="filtering-tables-to-process" data-toc="filtering-tables-to-process">Filtering Tables to Process</h2><p id="fb1b83a8_81274">There are options to filter tables included in <code class="code" id="fb1b83a8_81275">hms-mirror</code> process. You can select <code class="code" id="fb1b83a8_81276">-tf|--table-filter</code> to &quot;include&quot; only tables that match this 'regular-expression'. Inversely, use <code class="code" id="fb1b83a8_81277">-etf|--exclude-table-filter</code> to omit tables from the list. These options are mutually exclusive.</p><p id="fb1b83a8_81278">The filters for <code class="code" id="fb1b83a8_81279">-tf</code> and <code class="code" id="fb1b83a8_81280">-tef</code> are expressed as a 'regular-expression'. Complex expressions should be enclosed in quotes to ensure the commandline interpreter doesn't split them.</p><p id="fb1b83a8_81281">Additional table filters (<code class="code" id="fb1b83a8_81282">-tfs|--table-filter-size-limit</code> and <code class="code" id="fb1b83a8_81283">-tfp|--table-filter-partition-count-limit</code>) that check a tables data size and partition count limits can also be applied to narrow the range of tables you'll process.</p><p id="fb1b83a8_81284">The filter does NOT override the requirement for options like <code class="code" id="fb1b83a8_81285">-ma|-mao</code>. It is used as an additional filter.</p></section><section class="chapter"><h2 id="migrations-between-clusters-without-line-of-site" data-toc="migrations-between-clusters-without-line-of-site">Migrations between Clusters WITHOUT line of Site</h2><p id="fb1b83a8_81286">There will be cases where clusters can't be <a href="linking-cluster-storage-layers.html" id="fb1b83a8_81287" data-tooltip="For the hms-mirror process to work, it relies on the RIGHT clusters' ability to SEE and ACCESS data in the LEFT clusters HDFS namespace. This is the same access/configuration required to support DISTCP for an HA environment and accounts for failovers."  >linked</a>. And without this line of sight, data movement needs to happen through some other means.</p><section class="chapter"><h3 id="on-prem-to-cloud" data-toc="on-prem-to-cloud">On-Prem to Cloud</h3><p id="fb1b83a8_81288">This scenario is most common with &quot;on-prem&quot; to &quot;cloud&quot; migrations. Typically, <code class="code" id="fb1b83a8_81289">hms-mirror</code> is run from the <span class="control" id="fb1b83a8_81290">RIGHT</span> cluster, but in this case the <span class="control" id="fb1b83a8_81291">RIGHT</span> cloud cluster doesn't have line of site to the <span class="control" id="fb1b83a8_81292">LEFT</span> on-prem cluster. But the on-prem cluster will have limited line of site to the cloud environment. In this case, the only option is to run <code class="code" id="fb1b83a8_81293">hms-mirror</code> from the on-prem cluster. The on-prem cluster will need access to either an <code class="code" id="fb1b83a8_81294">-is|--intermediate-storage</code> location that both clusters can access or a <code class="code" id="fb1b83a8_81295">-cs|--common-storage</code> location that each cluster can see, but can be considered the final resting place for the cloud environment. The <code class="code" id="fb1b83a8_81296">-cs</code> option usually means there are fewer data hops required to complete the migration.</p><p id="fb1b83a8_81297">You'll run <code class="code" id="fb1b83a8_81298">hms-mirror</code> from a <span class="control" id="fb1b83a8_81299">LEFT</span> cluster edgenode. This node will require line of site to the Hive Server 2 endpoint in the <span class="control" id="fb1b83a8_81300">RIGHT</span> cloud environment. The <span class="control" id="fb1b83a8_81301">LEFT</span> cluster will also need to be configured with the appropriate libraries and configurations to write to the location defined in <code class="code" id="fb1b83a8_81302">-is|-cs</code>. For example: For S3, the <span class="control" id="fb1b83a8_81303">LEFT</span> cluster will need the AWS S3 libraries configured and the appropriate keys for S3 access setup to complete the transfer.</p></section></section><section class="chapter"><h2 id="shared-storage-models-isilon-spectrum-scale-etc" data-toc="shared-storage-models-isilon-spectrum-scale-etc">Shared Storage Models (Isilon, Spectrum-Scale, etc.)</h2><p id="fb1b83a8_81304">There are cases where 'HDFS' isn't the primary data source. So the only thing the cluster share is storage in these 'common' storage units. You want to transfer the schema, but the data doesn't need to move (at least for 'EXTERNAL' (non-transactional) tables). In this case, try the <code class="code" id="fb1b83a8_81305">-d|--data-strategy</code> COMMON. The schema's will go through all the needed conversions while the data remains in the same location.</p></section><section class="chapter"><h2 id="disconnected-mode" data-toc="disconnected-mode">Disconnected Mode</h2><p id="fb1b83a8_81306">Use the <code class="code" id="fb1b83a8_81307">-rid|--right-is-disconnected</code> mode when you need to build (and/or) transfer schema/datasets from one cluster to another, but you can't connect to both at the same time. See the issues log for details regarding the cases here <a href="https://github.com/cloudera-labs/hms-mirror/issues/17" id="fb1b83a8_81308"   data-external="true" rel="noopener noreferrer" >issue #17</a>.</p><p id="fb1b83a8_81309">Use cases:</p><ul class="list _ul" id="fb1b83a8_81310"    ><li class="list__item" id="fb1b83a8_81311"><p>Schema Only Transfers</p></li><li class="list__item" id="fb1b83a8_81312"><p>SQL, EXPORT_IMPORT, and HYBRID only when -is or -cs is used. This might be the case when the clusters are secure (kerberized), but don't share a common kerberos domain/user auth. So an intermediate or common storage location will be used to migrate the data.</p></li><li class="list__item" id="fb1b83a8_81313"><p>Both clusters (and HS2 endpoints) are Kerberized, but the clusters are NOT the same major hadoop version. In this case, hms-mirror doesn't support connecting to both of these endpoints at the same time. Running in the disconnected mode will help push through with the conversion.</p></li></ul><p id="fb1b83a8_81314">hms-mirror will run as normal, with the exception of examining and running scripts against the right cluster. It will be assumed that the RIGHT cluster elements do NOT exist.</p><p id="fb1b83a8_81315">The RIGHT_ 'execution' scripts and distcp commands will need to be run MANUALLY via Beeline on the RIGHT cluster.</p><p id="fb1b83a8_81316">Note: This will be know as the &quot;right-is-disconnected&quot; option. Which means the process should be run from a node that has access to the &quot;left&quot; cluster. This is 'counter' to our general recommendation that the process should be run from the 'right' cluster.</p></section><section class="chapter"><h2 id="no-purge-option" data-toc="no-purge-option">No-Purge Option</h2><p id="fb1b83a8_81317"><code class="code" id="fb1b83a8_81318">-np</code></p><p id="fb1b83a8_81319"><a href="https://github.com/cloudera-labs/hms-mirror/issues/25" id="fb1b83a8_81320"   data-external="true" rel="noopener noreferrer" >Feature Request #25</a> was introduced in v1.5.4.2 and gives the user to option to remove the <code class="code" id="fb1b83a8_81321">external.table.purge</code> option that is added when converting legacy managed tables to external table (Hive 1/2 to 3). This does affect the behavior of the table from the older platforms.</p></section><section class="chapter"><h2 id="property-overrides" data-toc="property-overrides">Property Overrides</h2><p id="fb1b83a8_81322"><code class="code" id="fb1b83a8_81323">-po[l|r] &lt;key=value&gt;[,&lt;key=value&gt;]...</code></p><p id="fb1b83a8_81324"><a href="https://github.com/cloudera-labs/hms-mirror/issues/27" id="fb1b83a8_81325"   data-external="true" rel="noopener noreferrer" >Feature Request #27</a> introduced in v1.5.4.2 provides the ability to set a hive properties at the beginning of each migration part. This is a comma separated list of key=value pairs with no space. If spaces are needed, quote the parameter on the commandline.</p><p id="fb1b83a8_81326">You can use <code class="code" id="fb1b83a8_81327">-po</code> to set the properties for BOTH clusters or <code class="code" id="fb1b83a8_81328">-pol</code>|<code class="code" id="fb1b83a8_81329">-por</code> to set them specifically for the 'left' and/or 'right' cluster.</p><p id="fb1b83a8_81330">For example: <code class="code" id="fb1b83a8_81331">-po hive.exec.orc.split.strategy=BI,hive.compute.query.using.stats=false</code></p><p id="fb1b83a8_81332">To provide a consistent list of settings for ALL jobs, add/modify the following section in the configuration file ie: <code class="code" id="fb1b83a8_81333">default.yaml</code> used for processing. In this case you do NOT need to use the commandline option. Although, you can set basic values in the configuration file and add other via the commandline.</p><p id="fb1b83a8_81334">Notice that there are setting for the LEFT and RIGHT clusters.</p><div class="code-block" data-lang="yaml"         >
optimization:
  overrides:
    left:
      tez.queue.name: &quot;compaction&quot;
    right:
      tez.queue.name: &quot;migration&quot;
      
</div></section><section class="chapter"><h2 id="global-location-map" data-toc="global-location-map">Global Location Map</h2><p id="fb1b83a8_81336"><code class="code" id="fb1b83a8_81337">-glm|--global-location-map &lt;from=to&gt;[,...]</code></p><p id="fb1b83a8_81338">This is an opportunity to make some specific directory mappings during the migration. You can supply a comma separated list of directory pairs to be use for evaluation.</p><p id="fb1b83a8_81339"><code class="code" id="fb1b83a8_81340">-glm /data/my_original_location=/corp/finance_new_loc,/user/hive=/warehouse/hive</code></p><p id="fb1b83a8_81341">These directory mappings ONLY apply to 'EXTERNAL' and 'DOWNGRADED ACID' tables. You can supply 'n' number of mappings to review through the commandline interface as describe above. To provide a consistent set of mappings to ALL jobs, add/modify the following section in the configuration file ie: <code class="code" id="fb1b83a8_81342">default.yaml</code> used for processing.</p><div class="code-block" data-lang="yaml"         >
translator:
  globalLocationMap:
    /data/my_original_location: &quot;/corp/finance_new_loc&quot;
    /user/hive: &quot;/warehouse/hive&quot;
</div><p id="fb1b83a8_81344">The list will be sorted by the length of the string, then alpha-numerically. This will ensure the deepest nested paths are evaluated FIRST. When a path is matched during evaluation, the process will NOT look and any more paths in the list. Therefore, avoiding possible double evaluations that may result when there are nested paths in the list.</p><p id="fb1b83a8_81345">Paths are evaluated with 'startsWith' on the original path (minus the original namespace). When a match is found, the path 'part' will be replaced with the value specified. The remaining path will remain intact and regardless of the <code class="code" id="fb1b83a8_81346">-rdl</code> setting, the LOCATION element will be included in the tables new CREATE statement.</p></section><section class="chapter"><h2 id="force-external-locations" data-toc="force-external-locations">Force External Locations</h2><p id="fb1b83a8_81347"><code class="code" id="fb1b83a8_81348">-fel|--force-external-location</code></p><p id="fb1b83a8_81349">Under some conditions, the default warehouse directory hierarchy is not honored. We've seen this in HDP 3. The <code class="code" id="fb1b83a8_81350">-rdl</code> option collects the external tables in the default warehouse directory by omitting the LOCATION element in the CREATE statement, relying on the default location. The default location is set at the DATABASE level by <code class="code" id="fb1b83a8_81351">hms-mirror</code>.</p><p id="fb1b83a8_81352">In HDP3, the CREATE statement doesn't honor the 'database' LOCATION element and reverts to the system wide warehouse directory configurations. The <code class="code" id="fb1b83a8_81353">-fel</code> flag will simply include the 'properly' adjusted LOCATION element in the CREATE statement to ensure the tables are created in the desired location. This setting overrides the effects intended by the <code class="code" id="fb1b83a8_81354">-rdl</code> option which intend to place the tables under the stated warehouse locations by omitting the location from the tables definition and relying on the default location specified in the database.</p><p id="fb1b83a8_81355"><code class="code" id="fb1b83a8_81356">-fel</code> will use the original location as a starting point. If <code class="code" id="fb1b83a8_81357">-wd|-ewd</code> are specified, they aren't not used in the translation, but warnings may be issued if the final location doesn't align with the warehouse directory. The effect change in the location when using <code class="code" id="fb1b83a8_81358">-fel</code>, add mappings via <code class="code" id="fb1b83a8_81359">-glm</code>.</p></section><section class="chapter"><h2 id="hdp-3-hive" data-toc="hdp-3-hive">HDP 3 Hive</h2><p id="fb1b83a8_81360">HDP 3 (Hive 3) was an incomplete implementation with regards to complex table 'location' management. When you are working in this environment, add to the cluster configuration (LEFT or RIGHT) the setting: <code class="code" id="fb1b83a8_81361">hdpHive3: true</code>. There is NOT a commandline switch for this. JUst add it to the configuration file you're using to run the application.</p><div class="code-block" data-lang="yaml"         >
clusters:
  LEFT:
    environment: &quot;LEFT&quot;
    legacyHive: false
    hdpHive3: true
</div><p id="fb1b83a8_81363">HDP3 Hive did NOT have a MANAGEDLOCATION attribute for Databases.</p><p id="fb1b83a8_81364">The LOCATION element tracked the Manage ACID tables and will control where they go.</p><p id="fb1b83a8_81365">This LOCATION will need to be transferred to MANAGEDLOCATION 'after' upgrading to CDP to ensure ACID tables maintain the same behavior. EXTERNAL tables will explicity set there LOCATION element to match the setting in <code class="code" id="fb1b83a8_81366">-ewd</code>.</p><p id="fb1b83a8_81367">Future external tables, when no location is specified, will be created in the <code class="code" id="fb1b83a8_81368">hive.metastore.warehouse.external.dir</code>. This value is global in HDP Hive3 and can NOT be set for individual databases.</p><p id="fb1b83a8_81369">Post upgrade to CDP, you should add a specific directory value at the database level for better control.</p></section><section class="chapter"><h2 id="schema-fix-features" data-toc="schema-fix-features">Schema Fix Features</h2><p id="fb1b83a8_81370">Schema Fix Features are a way to inject special considerations into the replay of a schema between clusters. Each schema is automatically check is a particular 'feature' applies.</p><p id="fb1b83a8_81371">If you find that this features check is causing issues, add the flag <code class="code" id="fb1b83a8_81372">-sf</code> to the application parameters and the feature checks will be skipped.</p><section class="chapter"><h3 id="bad-orc-def" data-toc="bad-orc-def">BAD_ORC_DEF</h3><p id="fb1b83a8_81373"><code class="code" id="fb1b83a8_81374">BAD_ORC_DEF</code> is a feature that corrects poorly executed schema definitions in legacy Hive 1/2 that don't translate into a functioning table in Hive 3. In this case, the legacy definition was defined with:</p><div class="code-block" data-lang="none"         >
ROW FORMAT DELIMITED
  FIELDS TERMINATED BY '\t'
  LINES TERMINATED BY '\n'
STORED AS INPUTFORMAT
  'org.apache.hadoop.hive.ql.io.orc.OrcInputFormat'
OUTPUTFORMAT
  'org.apache.hadoop.hive.ql.io.orc.OrcOutputFormat'
</div><p id="fb1b83a8_81376">when it should have been created with:</p><div class="code-block" data-lang="none"         >
STORED AS ORC
</div><p id="fb1b83a8_81378">The result, when not modified and replayed in Hive 3 is a table that isn't functional. The <code class="code" id="fb1b83a8_81379">BAD_ORC_DEF</code> feature will replace:</p><div class="code-block" data-lang="none"         >
ROW FORMAT DELIMITED
  FIELDS TERMINATED BY '\t'
  LINES TERMINATED BY '\n'
</div><p id="fb1b83a8_81381">with:</p><div class="code-block" data-lang="none"         >
ROW FORMAT SERDE
  'org.apache.hadoop.hive.ql.io.orc.OrcSerde'
</div></section><section class="chapter"><h3 id="bad-rc-def" data-toc="bad-rc-def">BAD_RC_DEF</h3><p id="fb1b83a8_81383"><code class="code" id="fb1b83a8_81384">BAD_RC_DEF</code> is a feature that corrects poorly executed schema definitions in legacy Hive 1/2 that doesn't translate into a functioning table in Hive 3. In this case, the legacy definition was defined with:</p><div class="code-block" data-lang="none"         >
ROW FORMAT DELIMITED,
    FIELDS TERMINATED BY '|'
 STORED AS INPUTFORMAT 
  'org.apache.hadoop.hive.ql.io.RCFileInputFormat'
 OUTPUTFORMAT 
  'org.apache.hadoop.hive.ql.io.RCFileOutputFormat'
</div><p id="fb1b83a8_81386">when it should have been created with:</p><div class="code-block" data-lang="none"         >
STORED AS RCFILE
</div><p id="fb1b83a8_81388">The result, when not modified and replayed in Hive 3 is a table that isn't functional. The <code class="code" id="fb1b83a8_81389">BAD_RC_DEF</code> feature will replace:</p><div class="code-block" data-lang="none"         >
ROW FORMAT DELIMITED,                              
    FIELDS TERMINATED BY '|'                       
 STORED AS INPUTFORMAT                             
</div><p id="fb1b83a8_81391">with:</p><div class="code-block" data-lang="none"         >
STORED AS RCFILE
</div></section><section class="chapter"><h3 id="bad-textfile-def" data-toc="bad-textfile-def">BAD_TEXTFILE_DEF</h3><p id="fb1b83a8_81393">Older Textfile schemas somehow are corrupted through subsequent ALTER statements that get the table into a state where you can NOT re-run the contents of <code class="code" id="fb1b83a8_81394">SHOW CREATE TABLE</code>. In this case, the issue is that there is a declaration for <code class="code" id="fb1b83a8_81395">WITH SERDEPROPERTIES</code> along with a <code class="code" id="fb1b83a8_81396">ROW FORMAT DELIMITED</code> clause. These two can NOT exist together. Here is an example of this:</p><div class="code-block" data-lang="none"         >
ROW FORMAT DELIMITED
     FIELDS TERMINATED BY '|'
     LINES TERMINATED BY '\n'
WITH SERDEPROPERTIES (
     'escape.delim'='\\')
STORED AS INPUTFORMAT
     'org.apache.hadoop.mapred.TextInputFormat'
OUTPUTFORMAT
     'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'
</div><p id="fb1b83a8_81398">In this case, we need to convert the <code class="code" id="fb1b83a8_81399">ROW FORMAT DELIMITED * TERMINATED BY *</code> values into the <code class="code" id="fb1b83a8_81400">SERDEPROPERTIES</code> and replace it with</p><div class="code-block" data-lang="none"         >
ROW FORMAT SERDE
  'org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe'
</div></section></section><div class="last-modified"> Last modified: 07 November 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="hive-sre-help.html">Help Options</a>   <a class="navigation-links__next" href="strategies.html">Strategies</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.1.5-b176/app.js"></script></body></html>