<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="built-on" content="2024-09-05T20:35:27.95806"><title>Scenarios | hms-mirror</title><script type="application/json" id="virtual-toc-data">[{"id":"one-time-migration-of-schema-s-from-left-to-right","level":0,"title":"One-time migration of SCHEMA\u0027s from LEFT to RIGHT.","anchor":"#one-time-migration-of-schema-s-from-left-to-right"},{"id":"dump-of-clusters-schema","level":0,"title":"DUMP of clusters SCHEMA","anchor":"#dump-of-clusters-schema"},{"id":"data-migration-for-non-acid-tables-using-sql","level":0,"title":"Data Migration for Non-ACID tables using SQL","anchor":"#data-migration-for-non-acid-tables-using-sql"},{"id":"data-migration-for-acid-tables-using-sql-or-hybrid","level":0,"title":"Data Migration for ACID tables using SQL or HYBRID","anchor":"#data-migration-for-acid-tables-using-sql-or-hybrid"},{"id":"schema-migration-of-specific-tables-using-regex","level":0,"title":"Schema Migration of specific tables using RegEx","anchor":"#schema-migration-of-specific-tables-using-regex"},{"id":"migrate-views-for-a-specific-database","level":0,"title":"Migrate VIEWS for a specific database","anchor":"#migrate-views-for-a-specific-database"},{"id":"create-schema-in-right-cluster-using-the-left-clusters-data","level":0,"title":"Create schema in RIGHT cluster using the LEFT clusters data","anchor":"#create-schema-in-right-cluster-using-the-left-clusters-data"},{"id":"migrate-schema-s-and-data-using-sql","level":0,"title":"Migrate SCHEMA\u0027s and Data using SQL","anchor":"#migrate-schema-s-and-data-using-sql"},{"id":"migrate-schema-s-and-data-using-export-import","level":0,"title":"Migrate SCHEMA\u0027s and Data using EXPORT_IMPORT","anchor":"#migrate-schema-s-and-data-using-export-import"},{"id":"migrate-schema-s-and-data-using-hybrid","level":0,"title":"Migrate SCHEMA\u0027s and Data using HYBRID","anchor":"#migrate-schema-s-and-data-using-hybrid"},{"id":"disaster-recovery-right-cluster-is-dr-and-read-only","level":0,"title":"Disaster Recovery (RIGHT Cluster is DR and READ-ONLY)","anchor":"#disaster-recovery-right-cluster-is-dr-and-read-only"},{"id":"downgrade-and-replace-acid-tables","level":0,"title":"Downgrade and Replace ACID tables","anchor":"#downgrade-and-replace-acid-tables"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.10.0-b408/app.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Scenarios | hms-mirror"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="hms-mirror Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/hms-mirror/v2.2.0.x/hms-mirror-leg-non-leg-scenarios.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Scenarios | hms-mirror"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/hms-mirror/v2.2.0.x/hms-mirror-leg-non-leg-scenarios.html#webpage",
    "url": "writerside-documentation/hms-mirror/v2.2.0.x/hms-mirror-leg-non-leg-scenarios.html",
    "name": "Scenarios | hms-mirror",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/hms-mirror/#website",
    "url": "writerside-documentation/hms-mirror/",
    "name": "hms-mirror Help"
}</script><!-- End Schema.org --></head><body data-id="hms-mirror-leg-non-leg-scenarios" data-main-title="Scenarios" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="use-cases.md|Use Cases///hms-mirror-legacy-to-non-legacy.md|On Prem Legacy Hive to Non-Legacy Hive"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>hms-mirror v2.2.0.x Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="hms-mirror-leg-non-leg-scenarios" id="hms-mirror-leg-non-leg-scenarios.md">Scenarios</h1><section class="chapter"><h2 id="one-time-migration-of-schema-s-from-left-to-right" data-toc="one-time-migration-of-schema-s-from-left-to-right">One-time migration of SCHEMA's from LEFT to RIGHT.</h2><p id="-gjhvbm_15">This is done with the basic <code class="code" id="-gjhvbm_19">SCHEMA_ONLY</code> data strategy (default) and will extract the schema's from the LEFT and replay them on the RIGHT cluster. In this mode, NO DATA is moved.</p><p id="-gjhvbm_16"><code class="code" id="-gjhvbm_20">hms-mirror -db tpcds_bin_partitioned_orc_10 -o temp</code></p><p id="-gjhvbm_17">Examine the reports place in the relative <code class="code" id="-gjhvbm_21">temp</code> directory specified with the <code class="code" id="-gjhvbm_22">-o</code> option. A report set is generated to each database.</p><p id="-gjhvbm_18">Since no data is transferred in this scenario, the expectation is that the data is managed by another process, like <code class="code" id="-gjhvbm_23">distcp</code>. The output of <code class="code" id="-gjhvbm_24">hms-mirror</code> will create some template distcp calls with the appropriate location details. You can use this as a starting point to managed this transfer.</p></section><section class="chapter"><h2 id="dump-of-clusters-schema" data-toc="dump-of-clusters-schema"><code class="code" id="-gjhvbm_30">DUMP</code> of clusters SCHEMA</h2><p id="-gjhvbm_26">We want a simple extraction of a database schema. An optional <code class="code" id="-gjhvbm_31">-ds LEFT|RIGHT</code> option can be specified to target which configured cluster to use. The default is <code class="code" id="-gjhvbm_32">LEFT</code>. Note: When you specify <code class="code" id="-gjhvbm_33">RIGHT</code>, the DUMP output with still show up in the <code class="code" id="-gjhvbm_34">LEFT</code> output report.</p><p id="-gjhvbm_27">No translations are done in this scenario. So if the DUMP is taken from a 'legacy' cluster, beware of the implications of 'replaying' it on a non-legacy cluster.</p><p id="-gjhvbm_28">This will use the LEFT cluster configuration for the schema DUMP of <code class="code" id="-gjhvbm_35">tpcds_bin_partititoned_orc_10</code>. <code class="code" id="-gjhvbm_36">hms-mirror -db tpcds_bin_partitioned_orc_10 -o temp -d DUMP</code></p><p id="-gjhvbm_29">This will use the RIGHT cluster configuration for the schema DUMP of <code class="code" id="-gjhvbm_37">tpcds_bin_partititoned_orc_10</code>. <code class="code" id="-gjhvbm_38">hms-mirror -db tpcds_bin_partitioned_orc_10 -o temp -d DUMP -ds RIGHT</code></p></section><section class="chapter"><h2 id="data-migration-for-non-acid-tables-using-sql" data-toc="data-migration-for-non-acid-tables-using-sql">Data Migration for Non-ACID tables using <code class="code" id="-gjhvbm_42">SQL</code></h2><p id="-gjhvbm_40">This approach assumes the clusters are <a href="linking-cluster-storage-layers.html" id="-gjhvbm_43" data-tooltip="For the hms-mirror process to work, it relies on the RIGHT clusters' ability to SEE and ACCESS data in the LEFT clusters HDFS namespace. This is the same access/configuration required to support DISTCP for an HA environment and accounts for failovers.">linked</a>. The SQL data strategy uses the RIGHT's clusters view into the HDFS filesystem of the LEFT cluster to facilitate data movement.</p><p id="-gjhvbm_41"><code class="code" id="-gjhvbm_44">hms-mirror -d SQL -db tpcds_bin_partitioned_orc_10 -o temp</code></p></section><section class="chapter"><h2 id="data-migration-for-acid-tables-using-sql-or-hybrid" data-toc="data-migration-for-acid-tables-using-sql-or-hybrid">Data Migration for ACID tables using <code class="code" id="-gjhvbm_49">SQL</code> or <code class="code" id="-gjhvbm_50">HYBRID</code></h2><p id="-gjhvbm_46">This approach assumes the clusters are <a href="linking-cluster-storage-layers.html" id="-gjhvbm_51" data-tooltip="For the hms-mirror process to work, it relies on the RIGHT clusters' ability to SEE and ACCESS data in the LEFT clusters HDFS namespace. This is the same access/configuration required to support DISTCP for an HA environment and accounts for failovers.">linked</a>. The SQL data strategy uses the RIGHT's clusters view into the HDFS filesystem of the LEFT cluster to facilitate data movement.</p><p id="-gjhvbm_47"><code class="code" id="-gjhvbm_52">hms-mirror -d SQL -db tpcds_bin_partitioned_orc_10 -o temp -ma</code></p><p id="-gjhvbm_48">Use <code class="code" id="-gjhvbm_53">-mao</code> to migrate ONLY ACID tables. <code class="code" id="-gjhvbm_54">-ma</code> will migrate ACID and Non-ACID tables.</p></section><section class="chapter"><h2 id="schema-migration-of-specific-tables-using-regex" data-toc="schema-migration-of-specific-tables-using-regex">Schema Migration of specific tables using RegEx</h2><p id="-gjhvbm_55">Using a RegEx pattern, filter the tables in the db to migrate.</p><p id="-gjhvbm_56"><code class="code" id="-gjhvbm_58">hms-mirror -db tpcds_bin_partitioned_orc_10 -tf call_*. -o temp</code></p><p id="-gjhvbm_57"><code class="code" id="-gjhvbm_59">-tf|--table-filter</code> followed by a RegEx to filter tables.</p></section><section class="chapter"><h2 id="migrate-views-for-a-specific-database" data-toc="migrate-views-for-a-specific-database">Migrate VIEWS for a specific database</h2><p id="-gjhvbm_60">View migration requires the underlying referenced tables exist BEFORE the 'view' can be created. This isn't a requirement of <code class="code" id="-gjhvbm_62">hms-mirror</code> rather a Hive requirement. Therefore, you should migrate the tables first as shown above and in a followup process run the following.</p><p id="-gjhvbm_61"><code class="code" id="-gjhvbm_63">hms-mirror -db tpcds_bin_partitioned_orc_10 -v</code></p></section><section class="chapter"><h2 id="create-schema-in-right-cluster-using-the-left-clusters-data" data-toc="create-schema-in-right-cluster-using-the-left-clusters-data">Create schema in RIGHT cluster using the LEFT clusters data</h2><p id="-gjhvbm_64">This is a helpful scenario for 'testing' workflows on the RIGHT cluster. The tables on the right cluster will NOT be configured with 'PURGE' to avoid the deletion of data on the LEFT cluster. These tables should be considered READ-ONLY. Test this against a sample dataset to THOROUGHLY understand the relationships here. This is NOT intended for 'production' use and should be used only as a validation mechanism for the RIGHT cluster.</p><p id="-gjhvbm_65">The clusters must be <a href="linking-cluster-storage-layers.html" id="-gjhvbm_69" data-tooltip="For the hms-mirror process to work, it relies on the RIGHT clusters' ability to SEE and ACCESS data in the LEFT clusters HDFS namespace. This is the same access/configuration required to support DISTCP for an HA environment and accounts for failovers.">linked</a>. Only legacy managed tables, external tables, and views can be linked. ACID tables can NOT be linked.</p><p id="-gjhvbm_66"><code class="code" id="-gjhvbm_70">hms-mirror -d LINKED -db tpcds_bin_partitioned_orc_10 -o temp</code></p><p id="-gjhvbm_67">The tables created on the RIGHT cluster will use the data located on the LEFT cluster. The 'database' will be created to match the database in the LEFT cluster.</p><p id="-gjhvbm_68">WARNING: If the LOCATION element is specified in the database definition AND you use <code class="code" id="-gjhvbm_71">DROP DATABASE ... CASCADE</code> from the RIGHT cluster, YOU WILL DROP THE DATA ON THE LEFT CLUSTER even though the tables are NOT purgeable. This is the DEFAULT behavior of hive 'DROP DATABASE'. So BE CAREFUL!!!!</p></section><section class="chapter"><h2 id="migrate-schema-s-and-data-using-sql" data-toc="migrate-schema-s-and-data-using-sql">Migrate SCHEMA's and Data using <code class="code" id="-gjhvbm_78">SQL</code></h2><p id="-gjhvbm_73">The clusters must be <a href="linking-cluster-storage-layers.html" id="-gjhvbm_79" data-tooltip="For the hms-mirror process to work, it relies on the RIGHT clusters' ability to SEE and ACCESS data in the LEFT clusters HDFS namespace. This is the same access/configuration required to support DISTCP for an HA environment and accounts for failovers.">linked</a>. In this scenario, we'll use the connected clusters and SQL to migrate data from the LEFT cluster to the RIGHT.</p><p id="-gjhvbm_74">There are limits regarding partitioned tables. For SQL migrations, the default is 500. Meaning that tables with more than 500 partitions will NOT attempt this transfer. This can be changed in the 'config' file by adding/changing <code class="code" id="-gjhvbm_80">hybrid-&gt;sqlPartitionLimit</code>. This was put in place as a general safeguard against attempts at tables with a partition count that may fail. It doesn't mean they'll always fail, it's just a place holder.</p><p id="-gjhvbm_75"><code class="code" id="-gjhvbm_81">hms-mirror -d SQL -db tpcds_bin_partitioned_orc_10 -o temp</code></p><p id="-gjhvbm_76">To transfer ACID tables, add <code class="code" id="-gjhvbm_82">-ma|-mao</code>.</p><p id="-gjhvbm_77">This is a one time transfer. Incremental updates aren't supported with this configuration. For incremental schema updates, see:</p></section><section class="chapter"><h2 id="migrate-schema-s-and-data-using-export-import" data-toc="migrate-schema-s-and-data-using-export-import">Migrate SCHEMA's and Data using <code class="code" id="-gjhvbm_89">EXPORT_IMPORT</code></h2><p id="-gjhvbm_84">EXPORT/IMPORT is a basic Hive process used to package table schemas and data into a transferable unit that can be replayed on the new cluster. For <code class="code" id="-gjhvbm_90">hms-mirror</code> there is a defined prefix for a transfer directory in the configuration <code class="code" id="-gjhvbm_91">transfer-&gt;exportBaseDirPrefix</code>. If this isn't defined, the default is <code class="code" id="-gjhvbm_92">/apps/hive/warehouse/export_</code>.</p><p id="-gjhvbm_85">There are performance implications to using EXPORT_IMPORT with partitioned tables. The IMPORT process is quite slow at loading partitions. We've defined limits in the config (which can be changed) <code class="code" id="-gjhvbm_93">hybrid-&gt;exportImportPartitionLimit</code>. The default is 100. If the number of partitions exceeds this value, we will NOT attempt the transfer and will note this in the output report.</p><p id="-gjhvbm_86">The clusters must be <a href="linking-cluster-storage-layers.html" id="-gjhvbm_94" data-tooltip="For the hms-mirror process to work, it relies on the RIGHT clusters' ability to SEE and ACCESS data in the LEFT clusters HDFS namespace. This is the same access/configuration required to support DISTCP for an HA environment and accounts for failovers.">linked</a>. The before mentioned prefix directory on the LEFT cluster is accessed by the IMPORT process that runs on the RIGHT cluster. If the namespace (and permissions) aren't correct, the IMPORT process will fail.</p><p id="-gjhvbm_87"><code class="code" id="-gjhvbm_95">hms-mirror -d EXPORT_IMPORT -db tpcds_bin_partitioned_orc_10 -o temp</code></p><p id="-gjhvbm_88">EXPORT_IMPORT will NOT work for ACIDv1 -&gt; ACIDv2 (Hive 1/2 to 3) conversions. Use <code class="code" id="-gjhvbm_96">SQL</code> or <code class="code" id="-gjhvbm_97">HYBRID</code> instead.</p></section><section class="chapter"><h2 id="migrate-schema-s-and-data-using-hybrid" data-toc="migrate-schema-s-and-data-using-hybrid">Migrate SCHEMA's and Data using <code class="code" id="-gjhvbm_104">HYBRID</code></h2><p id="-gjhvbm_99">The <code class="code" id="-gjhvbm_105">HYBRID</code> data strategy is a combination of the <code class="code" id="-gjhvbm_106">SQL</code> and <code class="code" id="-gjhvbm_107">EXPORT_IMPORT</code> data strategies. It uses basic rules to choose the more appropriate method for the table in question.</p><p id="-gjhvbm_100">The clusters must be <a href="linking-cluster-storage-layers.html" id="-gjhvbm_108" data-tooltip="For the hms-mirror process to work, it relies on the RIGHT clusters' ability to SEE and ACCESS data in the LEFT clusters HDFS namespace. This is the same access/configuration required to support DISTCP for an HA environment and accounts for failovers.">linked</a>.</p><p id="-gjhvbm_101">The process will first consider using <code class="code" id="-gjhvbm_109">EXPORT_IMPORT</code> unless:</p><ul class="list _bullet" id="-gjhvbm_102"><li class="list__item" id="-gjhvbm_110"><p>The table is ACIDv1 and you're migrating to ACIDv2 (Legacy to Non-Legacy Clusters)</p></li><li class="list__item" id="-gjhvbm_111"><p>The number of partitions exceed the value set by: <code class="code" id="-gjhvbm_112">hybrid-&gt;exportImportPartitionLimit</code>. The default is 100. When exceeded, the <code class="code" id="-gjhvbm_113">SQL</code> method will be used. The <code class="code" id="-gjhvbm_114">SQL</code> method will fail is the partition count exceeds the value of <code class="code" id="-gjhvbm_115">hybrid-&gt;sqlPartitionLimit</code>. The default is 500.</p></li></ul><p id="-gjhvbm_103"><code class="code" id="-gjhvbm_116">hms-mirror -d HYBRID -db tpcds_bin_partitioned_orc_10 -o temp</code></p></section><section class="chapter"><h2 id="disaster-recovery-right-cluster-is-dr-and-read-only" data-toc="disaster-recovery-right-cluster-is-dr-and-read-only">Disaster Recovery (RIGHT Cluster is DR and READ-ONLY)</h2><p id="-gjhvbm_117">The DR scenario will transfer schemas and subsequent runs will update the 'schema' if changes are made. This process does NOT move data. The process will generate a <code class="code" id="-gjhvbm_123">distcp</code> work plan for you to get started. You should modify that to use 'snapshot diffs' and managed the data migration through <code class="code" id="-gjhvbm_124">distcp</code>.</p><p id="-gjhvbm_118">You should first run the process in <code class="code" id="-gjhvbm_125">DRY-RUN</code> mode to get the <code class="code" id="-gjhvbm_126">distcp</code> plan. The data must be transferred first! This ensures that the database and table/partition directories are created BEFORE the schemas are replayed. If the schemas are applied before the <code class="code" id="-gjhvbm_127">distcp</code> with SNAPSHOT diffs, then <code class="code" id="-gjhvbm_128">hive</code> will own the directories and the <code class="code" id="-gjhvbm_129">distcp</code> with snapshots will fail.</p><p id="-gjhvbm_119">WARNING: Do not attempt to <code class="code" id="-gjhvbm_130">DROP DATABASE ... CASCADE</code> on the RIGHT cluster, this will modify the filesystem and cause the incremental <code class="code" id="-gjhvbm_131">distcp</code> with snapshots to fail.</p><p id="-gjhvbm_120"><code class="code" id="-gjhvbm_132">hms-mirror -d SCHEMA_ONLY -db tpcds_bin_partitioned_orc_10 -ro -sync</code></p><p id="-gjhvbm_121">This process will review the tables on the LEFT cluster with the RIGHT and either update the schema when it's changed (by dropping and recreating), add missing tables, or drop tables that don't exist anymore.</p><p id="-gjhvbm_122">Tables that are migrated this way will NOT have the <code class="code" id="-gjhvbm_133">PURGE</code> flag set on the RIGHT cluster. This allows us to <code class="code" id="-gjhvbm_134">DROP</code> a table without affecting the data for the <code class="code" id="-gjhvbm_135">-sync</code> process.</p></section><section class="chapter"><h2 id="downgrade-and-replace-acid-tables" data-toc="downgrade-and-replace-acid-tables">Downgrade and Replace ACID tables</h2><p id="-gjhvbm_136">In this scenario, you're choosing to downgrade ACID tables that are migrated, as well as the current tables on the source cluster.</p><p id="-gjhvbm_137"><code class="code" id="-gjhvbm_140">hms-mirror -db tpcds_bin_partitioned_orc_10 -mao -da -r</code></p><p id="-gjhvbm_138">This will migrate ACID tables only (-mao vs. -ma), downgrade them to EXTERNAL/PURGE tables, and 'replace' the current ACID table with a MANAGED Non-Transactional table in legacy environments OR a EXTERNAL/PURGE table in Hive3+ environments.</p><p id="-gjhvbm_139">Using the DRY-RUN mode, experiment with options <code class="code" id="-gjhvbm_141">-is</code> and <code class="code" id="-gjhvbm_142">-cs</code> for various implementations of this conversion.</p></section><div class="last-modified">Last modified: 06 September 2024</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="hms-mirror-legacy-to-non-legacy.html" class="navigation-links__prev">On Prem Legacy Hive to Non-Legacy Hive</a><a href="cloud-to-cloud-dr.html" class="navigation-links__next">Cloud to Cloud DR (AWS)</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.10.0-b408/app.js"></script></body></html>