<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex">  <meta name="built-on" content="2023-11-07T07:59:19.169295"><meta name="build-number" content="${buildNumber}">       <title>Troubleshooting | hms-mirror</title><script id="virtual-toc-data" type="application/json">[{"id":"application-doesn-t-seem-to-be-making-progress","level":0,"title":"Application doesn\u0027t seem to be making progress","anchor":"#application-doesn-t-seem-to-be-making-progress"},{"id":"application-won-t-start-noclassdeffounderror","level":0,"title":"Application won\u0027t start NoClassDefFoundError","anchor":"#application-won-t-start-noclassdeffounderror"},{"id":"cdp-hive-standalone-driver-for-cdp-7-1-8-chf-x-cummulative-hot-fix-won-t-connect","level":0,"title":"CDP Hive Standalone Driver for CDP 7.1.8 CHF x (Cummulative Hot Fix) won\u0027t connect","anchor":"#cdp-hive-standalone-driver-for-cdp-7-1-8-chf-x-cummulative-hot-fix-won-t-connect"},{"id":"failed-avro-table-creation","level":0,"title":"Failed AVRO Table Creation","anchor":"#failed-avro-table-creation"},{"id":"table-processing-completed-with-error","level":0,"title":"Table processing completed with ERROR.","anchor":"#table-processing-completed-with-error"},{"id":"connecting-to-hs2-via-kerberos","level":0,"title":"Connecting to HS2 via Kerberos","anchor":"#connecting-to-hs2-via-kerberos"},{"id":"auto-partition-discovery-not-working","level":0,"title":"Auto Partition Discovery not working","anchor":"#auto-partition-discovery-not-working"},{"id":"hive-sql-exception-hdfs-permissions-issues","level":0,"title":"Hive SQL Exception / HDFS Permissions Issues","anchor":"#hive-sql-exception-hdfs-permissions-issues"},{"id":"yarn-submission-stuck-in-accepted-phase","level":0,"title":"YARN Submission stuck in ACCEPTED phase","anchor":"#yarn-submission-stuck-in-accepted-phase"},{"id":"spark-dfs-access","level":0,"title":"Spark DFS Access","anchor":"#spark-dfs-access"},{"id":"permission-issues","level":0,"title":"Permission Issues","anchor":"#permission-issues"},{"id":"must-use-hiveinputformat-to-read-acid-tables","level":0,"title":"Must use HiveInputFormat to read ACID tables","anchor":"#must-use-hiveinputformat-to-read-acid-tables"},{"id":"acl-issues-across-cross-while-using-lower-clusters-storage","level":0,"title":"ACL issues across cross while using LOWER clusters storage","anchor":"#acl-issues-across-cross-while-using-lower-clusters-storage"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.1.5-b176/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Troubleshooting | hms-mirror"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="hms-mirror Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="hms-mirrortroubleshooting.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Troubleshooting | hms-mirror"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "hms-mirrortroubleshooting.html#webpage", "url": "hms-mirrortroubleshooting.html", "name": "Troubleshooting | hms-mirror", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "hms-mirror/#website", "url": "hms-mirror/", "name": "hms-mirror Help" }</script><!-- End Schema.org --> <!-- Mermaid light/dark themes -->  <link rel="stylesheet" type="text/css" href="mermaid.css">  </head>     <body data-id="Troubleshooting" data-main-title="Troubleshooting" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs=""  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>hms-mirror  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Troubleshooting"  id="Troubleshooting.md"  >Troubleshooting</h1>  <section class="chapter"><h2 id="application-doesn-t-seem-to-be-making-progress" data-toc="application-doesn-t-seem-to-be-making-progress">Application doesn't seem to be making progress</h2><p id="cd79444b_14917">All the counters for table processing aren't moving (review the hms-mirror.log) or (1.6.1.0+) the on screen logging of what tables are being added and metadata collected for has stopped.</p><p id="cd79444b_14918"><span class="control" id="cd79444b_14919">Solution</span></p><p id="cd79444b_14920">The application creates a pool of connection to the HiveServer2 instances on the LEFT and RIGHT to be used for processing. When the HiveServer2 doesn't support or doesn't have available the number of connections being requested from <code class="code" id="cd79444b_14921">hms-mirror</code>, the application will 'wait' forever on getting the connections requested.</p><p id="cd79444b_14922">Stop the application and lower the concurrency value to a value that can be supported.</p><div class="code-block" data-lang="yaml"         >
transfer:
  concurrency: 4
</div><p id="cd79444b_14924">Or, you could modify the HiveServer2 instance to handle the number of connections being requested.</p></section><section class="chapter"><h2 id="application-won-t-start-noclassdeffounderror" data-toc="application-won-t-start-noclassdeffounderror">Application won't start NoClassDefFoundError</h2><p id="cd79444b_14925">Error</p><div class="code-block" data-lang="none"         >
Exception in thread &quot;main&quot; java.lang.NoClassDefFoundError:
java/sql/Driver at java.base/java.lang.ClassLoader.defineClass1
</div><p id="cd79444b_14927"><code class="code" id="cd79444b_14928">hms-mirror</code> uses a classloader to separate the various jdbc classes (and versions) used to manage migrations between two different clusters. The application also has a requirement to run on older platforms, so the most common denominator is Java 8. Our method of loading and separating these libraries doesn't work in Java 9+.</p><p id="cd79444b_14929"><span class="control" id="cd79444b_14930">Solution</span></p><p id="cd79444b_14931">Please use Java 8 to run <code class="code" id="cd79444b_14932">hms-mirror</code>.</p></section><section class="chapter"><h2 id="cdp-hive-standalone-driver-for-cdp-7-1-8-chf-x-cummulative-hot-fix-won-t-connect" data-toc="cdp-hive-standalone-driver-for-cdp-7-1-8-chf-x-cummulative-hot-fix-won-t-connect">CDP Hive Standalone Driver for CDP 7.1.8 CHF x (Cummulative Hot Fix) won't connect</h2><p id="cd79444b_14933">If you are attempting to connect to a CDP 7.1.8 clusters Hive Server 2 with the CDP Hive Standalone Driver identified in the clusters <code class="code" id="cd79444b_14934">jarFile</code> property, you may not be able to connect. A security item addressed in these drivers changed the required classes.</p><p id="cd79444b_14935">If you see:</p><div class="code-block" data-lang="none"         >
java.lang.RuntimeException: java.lang.RuntimeException: java.lang.NoClassDefFoundError: org/apache/log4j/Level
</div><p id="cd79444b_14937">You will need to include additional jars in the <code class="code" id="cd79444b_14938">jarFile</code> property. The following jars are required:</p><div class="code-block" data-lang="none"         >
log4j-1.2-api-2.18.0.ja
log4j-api-2.18.0.jar
log4j-core-2.18.0.jar
</div><p id="cd79444b_14940">The feature enhancement that allows multiple jars to be specified in the <code class="code" id="cd79444b_14941">jarFile</code> property is available in <code class="code" id="cd79444b_14942">hms-mirror</code> 1.6.0.0 and later. See <a href="https://github.com/cloudera-labs/hms-mirror/issues/67" id="cd79444b_14943"   data-external="true" rel="noopener noreferrer" >Issue #47</a></p><p id="cd79444b_14944"><span class="control" id="cd79444b_14945">Solution</span></p><p id="cd79444b_14946">Using <code class="code" id="cd79444b_14947">hms-mirror</code> v1.6.0.0 or later, specify the additional jars in the <code class="code" id="cd79444b_14948">jarFile</code> property. For example: <code class="code" id="cd79444b_14949">jarFile: &quot;&lt;absolute_path_to&gt;/hive-jdbc-3.1.3000.7.1.8.28-1-standalone.jar:&lt;absolute_path_to&gt;/log4j-1.2-api-2.18.0.jar:&lt;absolute_path_to&gt;/log4j-api-2.18.0.jar:&lt;absolute_path_to&gt;/log4j-core-2.18.0.jar&quot;</code></p><p id="cd79444b_14950">These jar files can be found on the CDP edge node in <code class="code" id="cd79444b_14951">/opt/cloudera/parcels/CDH/jars/</code>.</p><p id="cd79444b_14952">Ensure that the standalone driver is list 'FIRST' in the <code class="code" id="cd79444b_14953">jarFile</code> property.</p></section><section class="chapter"><h2 id="failed-avro-table-creation" data-toc="failed-avro-table-creation">Failed AVRO Table Creation</h2><div class="code-block" data-lang="none"         >
Error while compiling statement: FAILED: Execution Error, return code 40000 from org.apache.hadoop.hive.ql.ddl.DDLTask. java.lang.RuntimeException: MetaException(message:org.apache.hadoop.hive.serde2.SerDeException Encountered AvroSerdeException determining schema. Returning signal schema to indicate problem: Unable to read schema from given path: /user/dstreev/test.avsc)
</div><p id="cd79444b_14955"><span class="control" id="cd79444b_14956">Solution</span></p><p id="cd79444b_14957">Validate that the 'schema' file has been copied over to the new cluster. If that has been done, check the permissions. In a non-impersonation environment (doas=false), the <code class="code" id="cd79444b_14958">hive</code> user must have access to the file.</p></section><section class="chapter"><h2 id="table-processing-completed-with-error" data-toc="table-processing-completed-with-error">Table processing completed with ERROR.</h2><p id="cd79444b_14959">We make various checks as we perform the migrations, and when those checks don't pass, the result is an error.</p><p id="cd79444b_14960"><span class="control" id="cd79444b_14961">Solution</span></p><p id="cd79444b_14962">In <a href="tips.html" id="cd79444b_14963" data-tooltip="This process can be a long-running process. It depends on how much you've asked it to do. Having the application terminated because the ssh session to the edgenode timed out and your computer went to sleep will be very disruptive."  >tips</a> we suggest running with <code class="code" id="cd79444b_14964">dry-run</code> first (default). This will catch the potential issues first, without taking a whole lot of time. Use this to remediate issues before executing.</p><p id="cd79444b_14965">If the scenario that causes the <code class="code" id="cd79444b_14966">ERROR</code> is known, a remediation summary will be in the output report under <span class="control" id="cd79444b_14967">Issues</span> for that table. Follow those instructions, then rerun the process with <code class="code" id="cd79444b_14968">--retry.</code> NOTE: <code class="code" id="cd79444b_14969">--retry</code> is currently tech preview and not thoroughly tested.</p></section><section class="chapter"><h2 id="connecting-to-hs2-via-kerberos" data-toc="connecting-to-hs2-via-kerberos">Connecting to HS2 via Kerberos</h2><p id="cd79444b_14970">Connecting to an HDP cluster running 2.6.5 with Binary protocol and Kerberos triggers an incompatibility issue: <code class="code" id="cd79444b_14971">Unrecognized Hadoop major version number: 3.1.1.7.1....</code></p><p id="cd79444b_14972"><span class="control" id="cd79444b_14973">Solution</span></p><p id="cd79444b_14974">The application is built with CDP libraries (excluding the Hive Standalone Driver). When <code class="code" id="cd79444b_14975">Kerberos is the</code>auth` protocol to connect to <span class="control" id="cd79444b_14976">Hive 1</span>, it will get the application libs which will NOT be compatible with the older cluster.</p><p id="cd79444b_14977">Kerberos connections are only supported to the CDP cluster.</p><p id="cd79444b_14978">When connecting via <code class="code" id="cd79444b_14979">Kerberos, you will need to include the</code>--hadoop-classpath<code class="code" id="cd79444b_14980">when launching</code>hms-mirror`.</p></section><section class="chapter"><h2 id="auto-partition-discovery-not-working" data-toc="auto-partition-discovery-not-working">Auto Partition Discovery not working</h2><p id="cd79444b_14981">I've set the <code class="code" id="cd79444b_14982">partitionDiscovery:auto</code> to <code class="code" id="cd79444b_14983">true,</code> but the partitions aren't getting discovered.</p><p id="cd79444b_14984"><span class="control" id="cd79444b_14985">Solution</span></p><p id="cd79444b_14986">In CDP Base/PVC versions &lt; 7.1.6 have not set the housekeeping thread that runs to activate this feature.</p><p id="cd79444b_14987">In the Hive metastore configuration in Cloudera Manager, set <code class="code" id="cd79444b_14988">metastore.housekeeping.threads.on=true</code> in the <span class="emphasis" id="cd79444b_14989">Hive Service Advanced Configuration Snippet (Safety Valve) for hive-site.xml</span></p><figure  id="cd79444b_14990"><img alt="pic" title="pic" src="images/hms_housekeeping_thread.png"  class="" width="1544" height="432"/></figure></section><section class="chapter"><h2 id="hive-sql-exception-hdfs-permissions-issues" data-toc="hive-sql-exception-hdfs-permissions-issues">Hive SQL Exception / HDFS Permissions Issues</h2><div class="code-block" data-lang="none"         >
Caused by: java.lang.RuntimeException: org.apache.hadoop.hive.ql.security.authorization.plugin.HiveAccessControlException:Permission denied: user [dstreev] does not have [ALL] privilege on [hdfs://HDP50/apps/hive/warehouse/tpcds_bin_partitioned_orc_10.db/web_site]
</div><p id="cd79444b_14992">This error is a permission error to HDFS. For HYBRID, EXPORT_IMPORT, SQL, and SCHEMA_ONLY (with <code class="code" id="cd79444b_14993">-ams</code> enabled), this could be an issue with cross-cluster HDFS access.</p><p id="cd79444b_14994">Review the output report for details of where this error occurred (LEFT or RIGHT cluster).</p><p id="cd79444b_14995">When dealing with CREATE DDL statements submitted through HS2 with a <code class="code" id="cd79444b_14996">LOCATION</code> element in them, the submitting <span class="emphasis" id="cd79444b_14997">user</span> <span class="control" id="cd79444b_14998">AND</span> the HS2 <span class="emphasis" id="cd79444b_14999">service account</span> must have permissions to the directory. Remember, with cross-cluster access, the user identity will originate on the RIGHT cluster and will be <span class="control" id="cd79444b_15000">EVALUATED</span> on the LEFT clusters storage layer.</p><p id="cd79444b_15001">For migrations, the <code class="code" id="cd79444b_15002">hms-mirror</code> running user (JDBC) and keytab user (HDFS) should be privileged users.</p><section class="chapter"><h3 id="example-and-ambari-hints" data-toc="example-and-ambari-hints">Example and Ambari Hints</h3><p id="cd79444b_15003">After checking permissions of 'dstreev': Found that the 'dstreev' user was NOT the owner of the files in these directories on the LEFT cluster. The user running the process needs to be in 'dfs.permissions.superusergroup' for the lower clusters 'hdfs' service. Ambari 2.6 has issues setting this property: https://jira.cloudera.com/browse/EAR-7805</p><p id="cd79444b_15004">Follow the workaround above or add the user to the 'hdfs' group. Or use Ranger to allow all access. On my cluster, with no Ranger, I had to use '/var/lib/ambari-server/resources/scripts/configs.py' to set it manually for Ambari.</p><p id="cd79444b_15005"><code class="code" id="cd79444b_15006">sudo ./configs.py --host=k01.streever.local --port=8080 -u admin -p admin -n hdp50 -c hdfs-site -a set -k dfs.permissions.superusergroup -v hdfs_admin</code></p></section></section><section class="chapter"><h2 id="yarn-submission-stuck-in-accepted-phase" data-toc="yarn-submission-stuck-in-accepted-phase">YARN Submission stuck in ACCEPTED phase</h2><p id="cd79444b_15007">The process uses a connection pool to hive. If the concurrency value for the cluster is too high, you may have reached the maximum ratio of AM (Application Masters) for the YARN queue.</p><p id="cd79444b_15008">Review the ACCEPTED jobs and review the jobs <span class="emphasis" id="cd79444b_15009">Diagnostics</span> status for details on <span class="emphasis" id="cd79444b_15010">why</span> the jobs is stuck.</p><p id="cd79444b_15011"><span class="control" id="cd79444b_15012">Solution</span></p><p id="cd79444b_15013">Either of:</p><ol class="list _decimal" id="cd79444b_15014"  type="1"  ><li class="list__item" id="cd79444b_15015"><p>Reduce the concurrency in the configuration file for <code class="code" id="cd79444b_15016">hms-mirror</code></p></li><li class="list__item" id="cd79444b_15017"><p>Increase the AM ratio or Queue size to allow the jobs to be submitted. This can be done while the process is running.</p></li></ol></section><section class="chapter"><h2 id="spark-dfs-access" data-toc="spark-dfs-access">Spark DFS Access</h2><p id="cd79444b_15018">If you have problems accessing HDFS from <code class="code" id="cd79444b_15019">spark-shell</code> or <code class="code" id="cd79444b_15020">spark-submit</code> try adding the following configuration to spark:</p><div class="code-block" data-lang="none"         >
--conf spark.yarn.access.hadoopFileSystems=hdfs://&lt;NEW_NAMESPACE&gt;,hdfs://&lt;OLD_NAMESPACE&gt;
</div></section><section class="chapter"><h2 id="permission-issues" data-toc="permission-issues">Permission Issues</h2><p id="cd79444b_15022"><code class="code" id="cd79444b_15023">HiveAccessControlException Permission denied user: [xxxx] does not have [ALL] privileges on ['location'] [state=42000,code=40000]</code></p><p id="cd79444b_15024">and possibly</p><p id="cd79444b_15025">In HS2 Logs: <code class="code" id="cd79444b_15026">Unauthorized connection for super-user</code></p><p id="cd79444b_15027"><span class="control" id="cd79444b_15028">Solution</span></p><p id="cd79444b_15029">Caused by the following:</p><ul class="list _ul" id="cd79444b_15030"    ><li class="list__item" id="cd79444b_15031"><p>The 'user' doesn't have access to the location as indicated in the message. Verify through 'hdfs' that this is true or not. If the user does NOT have access, grant them access and try again.</p></li><li class="list__item" id="cd79444b_15032"><p>The 'hive' service account running HS2 does NOT have access to the location. The message will mask this and present it as a 'user' issue, when it is in fact an issue with the 'hive' service account. Grant the account the appropriate access.</p></li><li class="list__item" id="cd79444b_15033"><p>The 'hive' service does NOT have proxy permissions to the storage layer. </p><ul class="list _ul" id="cd79444b_15034"    ><li class="list__item" id="cd79444b_15035"><p>Check the <code class="code" id="cd79444b_15036">hadoop.proxyuser.hive.hosts|groups</code> setting in <code class="code" id="cd79444b_15037">core-site.xml</code>. If you are running into this <code class="code" id="cd79444b_15038">super-user</code> error on the RIGHT cluster, while trying to access a storage location on the <span class="emphasis" id="cd79444b_15039">LEFT</span> cluster, ensure the proxy settings include the rights values in the RIGHT clusters <code class="code" id="cd79444b_15040">core-site.xml</code>, since that is where HS2 will pick it up from.</p></li></ul></li></ul></section><section class="chapter"><h2 id="must-use-hiveinputformat-to-read-acid-tables" data-toc="must-use-hiveinputformat-to-read-acid-tables">Must use HiveInputFormat to read ACID tables</h2><p id="cd79444b_15041">We've seen this while attempting to migrate ACID tables from older clusters (HDP 2.6). The error occurs when we try to extract the ACID table data to a 'transfer' external table on the LEFT cluster, which is 'legacy'.</p><p id="cd79444b_15042"><span class="control" id="cd79444b_15043">Solution</span></p><p id="cd79444b_15044">HDP 2.6.5, the lowest supported cluster version intended for this process, should be using the 'tez' execution engine <code class="code" id="cd79444b_15045">set hive.execution.engine=tez</code>. If the cluster has been upgraded from an older HDP version OR they've simply decided NOT to use the <code class="code" id="cd79444b_15046">tez</code> execution engine', you may get this error.</p><p id="cd79444b_15047">In <code class="code" id="cd79444b_15048">hms-mirror</code> releases 1.3.0.5 and above, we will explicitly run <code class="code" id="cd79444b_15049">set hive.execution.engine=tez</code> on the LEFT cluster when identified as a 'legacy' cluster. For version 1.3.0.4 (the first version to support ACID transfers), you'll need to set the hive environment for the HS2 instance you're connecting to use <code class="code" id="cd79444b_15050">tez</code> as the execution engine.</p></section><section class="chapter"><h2 id="acl-issues-across-cross-while-using-lower-clusters-storage" data-toc="acl-issues-across-cross-while-using-lower-clusters-storage">ACL issues across cross while using LOWER clusters storage</h2><p id="cd79444b_15051">Are you seeing something like this?</p><div class="code-block" data-lang="none"         >
org.apache.hadoop.hive.ql.ddl.DDLTask. MetaException(message:Got exception: org.apache.hadoop.security.AccessControlException Permission denied: user=hive, access=WRITE, inode=&quot;/apps/hive/warehouse/merge_files.db/merge_files_part_a_small_replacement&quot;:dstreev:hadoop:drwxr-xr-x at
</div><p id="cd79444b_15053">This is caused when trying to <code class="code" id="cd79444b_15054">CREATE</code> a table on the <span class="control" id="cd79444b_15055">RIGHT</span> cluster that references data on the <span class="control" id="cd79444b_15056">LEFT</span> cluster. When the LEFT cluster is setup differently with regard to impersonation (doas) than the RIGHT, transfer tables are created with POSIX permissions that may not allow the RIGHT cluster/user to access that location.</p><p id="cd79444b_15057"><span class="control" id="cd79444b_15058">Solution</span></p><p id="cd79444b_15059">Using Ranger on the LEFT cluster, open up the permissions to allow the requesting user access as identified.</p></section><div class="last-modified"> Last modified: 07 November 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="iceberg-migration.html">ICEBERG_MIGRATION</a>   <a class="navigation-links__next" href="use-cases.html">Use Cases</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.1.5-b176/app.js"></script></body></html>