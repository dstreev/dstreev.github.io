<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="built-on" content="2025-05-27T08:48:27.96548"><title>Warehouse Plans | hms-mirror</title><script type="application/json" id="virtual-toc-data">[{"id":"standard-locations","level":0,"title":"Standard Locations","anchor":"#standard-locations"},{"id":"warehouse-plans-explained","level":0,"title":"Warehouse Plans Explained","anchor":"#warehouse-plans-explained"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Warehouse Plans | hms-mirror"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="hms-mirror Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/hms-mirror/v3.x/warehouse-plans.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Warehouse Plans | hms-mirror"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/hms-mirror/v3.x/warehouse-plans.html#webpage",
    "url": "writerside-documentation/hms-mirror/v3.x/warehouse-plans.html",
    "name": "Warehouse Plans | hms-mirror",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/hms-mirror/#website",
    "url": "writerside-documentation/hms-mirror/",
    "name": "hms-mirror Help"
}</script><!-- End Schema.org --></head><body data-id="Warehouse-Plans" data-main-title="Warehouse Plans" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="Databases.md|Databases"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>hms-mirror v3.x Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Warehouse-Plans" id="Warehouse-Plans.md">Warehouse Plans</h1><p id="di4udg_3">Warehouse Plans in &quot;hms-mirror&quot; are a database-level configuration mechanism designed to manage and map storage locations within a Hive database during metadata migration. They involve reviewing the database metadata to identify all storage locations (e.g., table and partition locations for both External and Managed tables) and mapping these to predefined Warehouse Plan locations. The intersection of this metadata and the Warehouse Plan is then used to construct <span class="control" id="di4udg_11">Global Location Maps</span>, which &quot;hms-mirror&quot; uses internally to provide a consistent mapping between storage systems across clusters or within a single cluster.</p><p id="di4udg_4">There are three types of 'Warehouse Plans'.</p><ul class="list _bullet" id="di4udg_5"><li class="list__item" id="di4udg_12"><p id="di4udg_15">Global</p></li><li class="list__item" id="di4udg_13"><p id="di4udg_16">Per Database</p></li><li class="list__item" id="di4udg_14"><p id="di4udg_17">Environment</p></li></ul><p id="di4udg_6">When you choose to 'ALIGN' your datasets during the migration (See <a href="location-alignment.html" id="di4udg_18" data-tooltip="In the Hive Metastore, Database definitions, Table Schemas, and Partition details include the location of their datasets. These locations contain a full URI to the dataset. Migrating from one cluster to another requires us to make adjustments to these locations.">Location Alignment</a> for settings that are applicable for each strategy), we'll evaluate the warehouse plans to determine where each dataset should land. If you're using 'SQL' to move data, we'll build the schema's and sql that will make the adjustments required to reorganize the data based on the warehouse plan that is found.</p><p id="di4udg_7">It's recommended to define a warehouse plan for each <span class="control" id="di4udg_19">database</span> you want to move when you're using the 'ALIGNED' data movement strategy. When this is defined for the database, we'll inspect the all the current locations of tables and partitions in that dataset and make the necessary adjustments to locations.</p><p id="di4udg_8">The 'Warehouse Plans' get converted into 'Global Location Maps' that are inspected during processing to make that conversion.</p><section class="chapter"><h2 id="standard-locations" data-toc="standard-locations">Standard Locations</h2><p id="di4udg_20">When you choose to <span class="control" id="di4udg_22">ALIGN</span> the datasets, you are choosing to collect everything in the dataset/database under the same location as you've defined in the <span class="control" id="di4udg_23">warehouse plan</span>. When you choose <code class="code" id="di4udg_24">DISTCP</code> as the movement plan for <code class="code" id="di4udg_25">ALIGNED</code>, we'll build a distcp plan that will make those translations. <span class="control" id="di4udg_26">BUT</span>, there are some restrictions to this.</p><p id="di4udg_21">When you choose to use non-standard locations for 'partition specs', we can't build a proper <code class="code" id="di4udg_27">distcp</code> plan. In this case we will throw an 'error' for the offending table and describe to imbalance. You can either fix/adjust the dataset OR choose to use the <code class="code" id="di4udg_28">SQL</code> data movement strategy.</p></section><section class="chapter"><h2 id="warehouse-plans-explained" data-toc="warehouse-plans-explained">Warehouse Plans Explained</h2><section class="chapter"><h3 id="what-are-warehouse-plans-for" data-toc="what-are-warehouse-plans-for">What Are Warehouse Plans For?</h3><ul class="list _bullet" id="di4udg_33"><li class="list__item" id="di4udg_35"><p id="di4udg_37"><span class="control" id="di4udg_38">Purpose</span>: At the database level, Warehouse Plans define how storage locations in the source database metadata are translated to target locations. This process ensures that the migrated metadata aligns with the desired storage structure on the target system. Unlike the earlier <a href="release-notes.html#global-location-maps" id="di4udg_39" data-tooltip="Previous releases had a fairly basic implementation of 'Global Location Maps'. These could be supplied through the cli option -glm, which is still supported, but limited in functionality. The improved implementation work from the concept of building 'Warehouse Plans' which are thenâ€¦"><code class="code" id="di4udg_40">globalLocationMap</code></a>, which offered a simpler, global key-value mapping, Warehouse Plans operate specifically at the database scope, providing a more targeted and detailed approach.</p></li><li class="list__item" id="di4udg_36"><p id="di4udg_41"><a href="database-warehouse-plans.html" id="di4udg_42" data-tooltip=""><span class="control" id="di4udg_44">Database Warehouse Plans</span></a>: These are the core of the feature, specifying location mappings for a single database. The documentation implies that <a href="global-warehouse-plans.html" id="di4udg_43" data-tooltip="Global Warehouse Plans">&quot;Global Warehouse Plans&quot;</a> may extend this concept across multiple databases, but the primary focus is on individual database-level planning.</p></li></ul><p id="di4udg_34">The resulting Global Location Maps, derived from Warehouse Plans, serve as an internal framework for &quot;hms-mirror&quot; to handle location translations during migration, ensuring consistency between source and target storage systems.</p></section><section class="chapter"><h3 id="what-to-use-warehouse-plans-for" data-toc="what-to-use-warehouse-plans-for">What to Use Warehouse Plans For?</h3><p id="di4udg_45">Warehouse Plans are primarily designed for scenarios where storage locations within a database need to be systematically mapped or reorganized during a migration. Here&rsquo;s an explanation of their use cases, reflecting their database-level scope and original intent for <code class="code" id="di4udg_47">STORAGE_MIGRATION</code>, as well as their broader applicability:</p><ol class="list _decimal" id="di4udg_46" type="1"><li class="list__item" id="di4udg_48"><p id="di4udg_53"><span class="control" id="di4udg_55">Primary Use Case: Storage Migration Within a Cluster (STORAGE_MIGRATION)</span>:</p><ul class="list _bullet" id="di4udg_54"><li class="list__item" id="di4udg_56"><p id="di4udg_60"><span class="control" id="di4udg_61">Scenario</span>: You&rsquo;re migrating the storage layer behind a database&rsquo;s metadata from HDFS to Ozone (or another system like an encrypted zone), as highlighted in the <span id="di4udg_62"><code class="code" id="di4udg_63">STORAGE_MIGRATION</code> strategy</span>.</p></li><li class="list__item" id="di4udg_57"><p id="di4udg_64"><span class="control" id="di4udg_65">Use</span>: Define a Warehouse Plan for the database to map all existing locations (e.g., <code class="code" id="di4udg_66">/apps/hive/warehouse/my_db</code>) to a new target (e.g., <code class="code" id="di4udg_67">ofs://ozone1/vol1/bucket1/my_db</code>). The metadata is reviewed, and all table and partition locations are updated accordingly. The resulting Global Location Maps ensure the migration reflects the new storage system.</p></li><li class="list__item" id="di4udg_58"><p id="di4udg_68"><span class="control" id="di4udg_71">Example</span>: For a database <code class="code" id="di4udg_72">finance_db</code>:</p><div class="code-block" data-lang="yaml">
databaseWarehousePlans:
  finance_db:
    EXTERNAL_TABLE: &quot;/finance_db/ext&quot;
    MANAGED_TABLE: &quot;/finance_db/managed&quot;
</div><p id="di4udg_70">This maps all External and Managed table locations within <code class="code" id="di4udg_73">finance_db</code> to the specified Ozone paths.</p></li><li class="list__item" id="di4udg_59"><p id="di4udg_74">The Ozone Namespace is pulled from the <code class="code" id="di4udg_76">targetNamespace</code> which can be set in the config or via the Web UI.</p><div class="code-block" data-lang="yaml">
transfer:
  targetNamespace: ofs://myOzone
</div></li></ul></li><li class="list__item" id="di4udg_49"><p id="di4udg_77"><span class="control" id="di4udg_79">Reorganizing Storage During Schema Migration (SCHEMA_ONLY)</span>:</p><ul class="list _bullet" id="di4udg_78"><li class="list__item" id="di4udg_80"><p id="di4udg_83"><span class="control" id="di4udg_84">Scenario</span>: You&rsquo;re migrating a database&rsquo;s schema between clusters (e.g., on-premises to cloud) using <code class="code" id="di4udg_85">SCHEMA_ONLY</code> (page 150), and you want to reorganize storage locations simultaneously.</p></li><li class="list__item" id="di4udg_81"><p id="di4udg_86"><span class="control" id="di4udg_87">Use</span>: A Warehouse Plan can redefine the database&rsquo;s storage locations (e.g., from <code class="code" id="di4udg_88">/data/my_db</code> to <code class="code" id="di4udg_89">s3a://mybucket/my_db</code>). Since <code class="code" id="di4udg_90">SCHEMA_ONLY</code> doesn&rsquo;t move data, pair it with the <a href="cli-options.html" id="di4udg_91" data-tooltip="Commandline Help (Options) FlagsArgumentDescription -accept, --accept Accept ALL confirmations and silence prompts -ap, --acid-partition-countSet the limit of partitions that the ACID strategy will work with. '-1' means no-limit. -asm, --avro-schema-migration Migrate AVRO Schemaâ€¦"><code class="code" id="di4udg_93">-dc|--distcp</code> option</a> to generate <code class="code" id="di4udg_92">distcp</code> plans for separately migrating the data to the new locations.</p></li><li class="list__item" id="di4udg_82"><p id="di4udg_94"><span class="control" id="di4udg_97">Example</span>:</p><div class="code-block" data-lang="yaml">
databaseWarehousePlans:
  my_db:
    EXTERNAL_TABLE: &quot;/my_db/ext&quot;
    MANAGED_TABLE: &quot;/my_db/managed&quot;
</div><p id="di4udg_96">Run: <code class="code" id="di4udg_98">hms-mirror -d SCHEMA_ONLY -db my_db -dc</code> to get the schema migration and a <code class="code" id="di4udg_99">distcp</code> plan. Again, use the <code class="code" id="di4udg_100">transfer.targetNamespace</code> to set the <code class="code" id="di4udg_101">s3</code> location. EG <code class="code" id="di4udg_102">s3a://mybucket</code>.</p></li></ul></li><li class="list__item" id="di4udg_50"><p id="di4udg_103"><span class="control" id="di4udg_105">Migrating and Moving Data with SQL Strategy (SQL)</span>:</p><ul class="list _bullet" id="di4udg_104"><li class="list__item" id="di4udg_106"><p id="di4udg_109"><span class="control" id="di4udg_110">Scenario</span>: You&rsquo;re using the <a href="sql.html" id="di4udg_111" data-tooltip="The SQL data strategy will use Hive SQL to move data between clusters. When the cluster don't have direct line of sight to each other and can NOT be linked, you can use options like -cs or -is to bridge the gap."><code class="code" id="di4udg_112">SQL</code> data strategy</a> to migrate both metadata and data between linked clusters, and you need to adjust storage locations.</p></li><li class="list__item" id="di4udg_107"><p id="di4udg_113"><span class="control" id="di4udg_114">Use</span>: Define a Warehouse Plan to map the database&rsquo;s locations to the target cluster&rsquo;s storage (e.g., from <code class="code" id="di4udg_115">hdfs://source/my_db</code> to <code class="code" id="di4udg_116">hdfs://target/my_db</code>). The SQL strategy will move the data to the new locations as part of the migration.</p></li><li class="list__item" id="di4udg_108"><p id="di4udg_117"><span class="control" id="di4udg_120">Example</span>:</p><div class="code-block" data-lang="yaml">
databaseWarehousePlans:
  my_db:
    EXTERNAL_TABLE: &quot;/my_db/ext&quot;
    MANAGED_TABLE: &quot;/my_db/managed&quot;
</div><p id="di4udg_119">Run: <code class="code" id="di4udg_121">hms-mirror -d SQL -db my_db</code>.</p></li></ul></li><li class="list__item" id="di4udg_51"><p id="di4udg_122"><span class="control" id="di4udg_124">Supporting Data Strategies Without Data Movement</span>:</p><ul class="list _bullet" id="di4udg_123"><li class="list__item" id="di4udg_125"><p id="di4udg_128"><span class="control" id="di4udg_129">Scenario</span>: You&rsquo;re using a strategy like <a href="schema-only.html" id="di4udg_130" data-tooltip="This strategy is used to migrate &quot;only&quot; the schema (mostly). When migrating from a legacy (Hive 1/2) hive environment to a non-legacy (Hive 3+) hms-mirror will convert tables that are &quot;managed non-transactional&quot; to &quot;external/purge&quot;. This translation isâ€¦"><code class="code" id="di4udg_131">SCHEMA_ONLY</code></a> that doesn&rsquo;t move data, but you need a plan to migrate the data later.</p></li><li class="list__item" id="di4udg_126"><p id="di4udg_132"><span class="control" id="di4udg_133">Use</span>: Warehouse Plans map the database&rsquo;s locations, and the <code class="code" id="di4udg_134">-dc|--distcp</code> option generates <code class="code" id="di4udg_135">distcp</code> scripts to handle the data migration separately, aligning with the mapped locations.</p></li><li class="list__item" id="di4udg_127"><p id="di4udg_136"><span class="control" id="di4udg_139">Example</span>: For <code class="code" id="di4udg_140">SCHEMA_ONLY</code>:</p><div class="code-block" data-lang="bash">
hms-mirror -d SCHMEA_ONLY -db my_db -dc -wps my_db=/my_db/ext:/my_db/managed
</div><p id="di4udg_138">The Warehouse Plan ensures the dump reflects the intended target locations, and <code class="code" id="di4udg_141">distcp</code> plans are provided.</p></li></ul></li><li class="list__item" id="di4udg_52"><p id="di4udg_142"><span class="control" id="di4udg_144">Consistency Within a Database Across Table Types</span>:</p><ul class="list _bullet" id="di4udg_143"><li class="list__item" id="di4udg_145"><p id="di4udg_148"><span class="control" id="di4udg_149">Scenario</span>: A database contains both External and Managed tables with various locations, and you want a unified storage structure on the target.</p></li><li class="list__item" id="di4udg_146"><p id="di4udg_150"><span class="control" id="di4udg_151">Use</span>: A Warehouse Plan reviews all locations in the database metadata and maps them to consistent target locations, regardless of table type. This is more precise than global mappings, as it&rsquo;s tailored to the database.</p></li><li class="list__item" id="di4udg_147"><p id="di4udg_152"><span class="control" id="di4udg_154">Example</span>: Mapping all tables in <code class="code" id="di4udg_155">sales_db</code> to a single storage layer:</p><div class="code-block" data-lang="yaml">
databaseWarehousePlans:
  sales_db:
    EXTERNAL_TABLE: &quot;/new_storage/division_ext&quot;
    MANAGED_TABLE: &quot;/new_storage/division_mngd&quot;
</div></li></ul></li></ol></section><section class="chapter"><h3 id="how-to-use-warehouse-plans" data-toc="how-to-use-warehouse-plans">How to Use Warehouse Plans</h3><p id="di4udg_156">To implement Warehouse Plans, configure them in the <code class="code" id="di4udg_159">default.yaml</code> file under the <code class="code" id="di4udg_160">databaseWarehousePlans</code> section at the database level.</p><p id="di4udg_157">Here&rsquo;s how, based on the documentation and your clarification:</p><ul class="list _bullet" id="di4udg_158"><li class="list__item" id="di4udg_161"><p id="di4udg_164"><span class="control" id="di4udg_167">Syntax</span>:</p><div class="code-block" data-lang="yaml">
databaseWarehousePlans:
  &lt;database_name&gt;:
    EXTERNAL_TABLE: &quot;&lt;target_location_for_external&gt;&quot;
    MANAGED_TABLE: &quot;&lt;target_location_for_managed&gt;&quot;
</div><ul class="list _bullet" id="di4udg_166"><li class="list__item" id="di4udg_168"><p id="di4udg_170">The metadata for <code class="code" id="di4udg_171">&lt;database_name&gt;</code> is analyzed, and all locations (for External and Managed tables) are mapped to the specified targets. These mappings feed into the Global Location Maps used internally.</p></li><li class="list__item" id="di4udg_169"><p id="di4udg_172">NOTE: The database name is appended to the location you specify, so do NOT include that in the location. This allows you to use the same location for multiple databases in the scenario you want to have multiple databases share the same root location.</p></li></ul></li><li class="list__item" id="di4udg_162"><p id="di4udg_173"><span class="control" id="di4udg_178">Command-Line Integration</span>: While Warehouse Plans are configuration-driven, they work with strategies like <code class="code" id="di4udg_179">STORAGE_MIGRATION</code>, <code class="code" id="di4udg_180">SCHEMA_ONLY</code>, or <code class="code" id="di4udg_181">SQL</code>. Use <code class="code" id="di4udg_182">-dc|--distcp</code> for strategies without data movement.</p><ul class="list _bullet" id="di4udg_174"><li class="list__item" id="di4udg_183"><p id="di4udg_184">The Warehouse Plans can be set in the config, via the Web UI, or via the commandline option <code class="code" id="di4udg_185">-wps &lt;db=ext-dir:mngd-dir[,db=ext-dir:mngd-dir]...&gt;</code></p></li></ul><div class="code-block" data-lang="none">
hms-mirror -d STORAGE_MIGRATION -db my_db -dc -wps my_db=/my_db/ext:/my_db/managed
</div><p id="di4udg_176">or</p><div class="code-block" data-lang="none">
hms-mirror -d SCHEMA_ONLY -db my_db -dc
</div></li><li class="list__item" id="di4udg_163"><p id="di4udg_186"><span class="control" id="di4udg_187">Execution</span>: The Warehouse Plan drives the location translation process. For <code class="code" id="di4udg_188">STORAGE_MIGRATION</code>, data is moved directly (if using <code class="code" id="di4udg_189">DISTCP</code> or <code class="code" id="di4udg_190">SQL</code> as the data movement strategy, page 202). For other strategies, <code class="code" id="di4udg_191">-dc</code> ensures data migration plans are provided.</p></li></ul></section><section class="chapter"><h3 id="practical-tips" data-toc="practical-tips">Practical Tips</h3><ul class="list _bullet" id="di4udg_192"><li class="list__item" id="di4udg_194"><p id="di4udg_198"><span class="control" id="di4udg_199">Database Scope</span>: Define Warehouse Plans per database to ensure precise mapping. Unlike the older <code class="code" id="di4udg_200">globalLocationMap</code>, they don&rsquo;t apply globally unless explicitly extended via &quot;Global Warehouse Plans.&quot;</p></li><li class="list__item" id="di4udg_195"><p id="di4udg_201"><span class="control" id="di4udg_202">Dry-Run</span>: Test with a dry-run (<code class="code" id="di4udg_203">hms-mirror -db &lt;db_name&gt;</code>) to review the mappings in the output reports (page 111) before executing (<code class="code" id="di4udg_204">-e</code>).</p></li><li class="list__item" id="di4udg_196"><p id="di4udg_205"><span class="control" id="di4udg_206">Storage Access</span>: Verify permissions for the mapped locations, especially for cross-cluster scenarios (page 69, &quot;Linking Cluster Storage Layers&quot;).</p></li><li class="list__item" id="di4udg_197"><p id="di4udg_207"><span class="control" id="di4udg_208">Original Intent</span>: While designed for <code class="code" id="di4udg_209">STORAGE_MIGRATION</code> (e.g., HDFS to Ozone), their flexibility supports broader reorganization tasks.</p></li></ul><p id="di4udg_193">In summary, Warehouse Plans are a database-level tool in &quot;hms-mirror&quot; for mapping storage locations within a database&rsquo;s metadata, originally for <code class="code" id="di4udg_210">STORAGE_MIGRATION</code> (e.g., HDFS to Ozone), but also valuable for <code class="code" id="di4udg_211">SCHEMA_ONLY</code> and <code class="code" id="di4udg_212">SQL</code> strategies. They construct Global Location Maps internally, ensuring accurate location translations, and can be paired with <code class="code" id="di4udg_213">-dc|--distcp</code> for separate data movement when needed.</p></section></section><div class="last-modified">16 May 2025</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="databases.html" class="navigation-links__prev">Databases</a><a href="global-warehouse-plans.html" class="navigation-links__next">Global Warehouse Plans</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.js"></script></body></html>